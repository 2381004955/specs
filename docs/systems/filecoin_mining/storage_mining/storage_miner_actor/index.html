<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storage Miner Actor | Filecoin Spec</title>



<link rel="stylesheet" href="../../../../../book.min.80d177ba9eeab42f747930aec886ccdf593ccbbd4ea5800f45db583ed39a4aed.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=EB+Garamond" />


<link rel="icon" href="../../../../../favicon.png" type="image/x-icon">



<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript" src="./gumshoe.polyfills.min.js"></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <link rel="stylesheet" href="../../../../../css/syntax.css">
<link href="../../../../../mermaid/mermaid.css" type="text/css" rel="stylesheet" />
<script src="../../../../../mermaid/mermaid.js"></script>
<script src="../../../../../spec.js"></script>

</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href=""><span>Filecoin Spec</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2f docs\2fsystems\2f filecoin_mining\2fstorage_mining\2fstorage_miner_actor\2f "] {
      color: #0b3a53;
  }
  </style>


  <div id="menu-toc">

  <div>
    
    <input id="menu-detail-slider" type="range" onchange="onMenuDetailChange();"
      min="1" value="3" max="5" step="1" />

    <span id="menu-detail-slider-label">3</span>
  </div>

  
  
  <ul class="menu-item-section depth-0">
  
      <li>
      
        











<a href="../../../../../#intro" class="menu-item depth-1">
    
    
    <strong>
    
        Introduction
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../../#intro__arch" class="menu-item depth-2">
    
    
        Architecture Diagrams
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#intro__concepts" class="menu-item depth-2">
    
    
        Key Concepts
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#intro__filecoin_vm" class="menu-item depth-2">
    
    
        Filecoin VM
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#intro__process" class="menu-item depth-2">
    
    
        Process
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#intro__process__about" class="menu-item depth-3">
    
    
        About
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#intro__process__fip" class="menu-item depth-3">
    
    
        FIPs
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#intro__process__contributing" class="menu-item depth-3">
    
    
        Contributing
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#intro__process__related_resources" class="menu-item depth-3">
    
    
        Related Resources
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#intro__process__related_resources__research_portal" class="menu-item depth-4">
    
    
        Research portal
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#intro__process__related_resources__network_tooling" class="menu-item depth-4">
    
    
        Network tooling
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#intro__process__related_resources__testing" class="menu-item depth-4">
    
    
        Testing and implementation compliance
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#intro__changelog" class="menu-item depth-2">
    
    
        Change Log
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#intro__system" class="menu-item depth-2">
    
    
        System Decomposition
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#intro__system__why_systems" class="menu-item depth-3">
    
    
        What are Systems?
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#intro__system__impl_systems" class="menu-item depth-3">
    
    
        Implementing Systems
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../../#systems" class="menu-item depth-1">
    
    
    <strong>
    
        Systems
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes" class="menu-item depth-2">
    ⚙️
    
        <strong>Filecoin Nodes</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types" class="menu-item depth-3">
    
    
        Node Types
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types__node" class="menu-item depth-4">
    
    
        Node Interface
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types__node_types" class="menu-item depth-4">
    
    
        Examples
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types__verifier_node" class="menu-item depth-4">
    
    
        Chain Verifier Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types__client_node" class="menu-item depth-4">
    
    
        Client Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types__storage_miner_node" class="menu-item depth-4">
    
    
        Storage Miner Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types__retrieval_miner_node" class="menu-item depth-4">
    
    
        Retrieval Miner Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__node_types__relayer_node" class="menu-item depth-4">
    
    
        Relayer Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_nodes__repository" class="menu-item depth-3">
    
    
        Repository
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_nodes__repository__config" class="menu-item depth-4">
    
    
        Config
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__repository__key" class="menu-item depth-4">
    
    
        KeyStore &amp; user keys
    
</a>



<ul class="menu-item-section depth-4">

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_nodes__repository__ipldstore" class="menu-item depth-4">
    
    
        IpldStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__repository__usage" class="menu-item depth-4">
    
    
        Usage in Systems
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__network" class="menu-item depth-3">
    
    
        Network Interface
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__clock" class="menu-item depth-3">
    
    
        Clock
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_nodes__key_store" class="menu-item depth-3">
    
    
        Key Store
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_files" class="menu-item depth-2">
    📑
    
        <strong>Files &amp; Data</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../../#systems__filecoin_files__file" class="menu-item depth-3">
    
    
        File
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_files__file__filestore" class="menu-item depth-4">
    
    
        FileStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_files__piece" class="menu-item depth-3">
    
    
        Piece
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_files__piece__piece_store" class="menu-item depth-4">
    
    
        PieceStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_files__data_transfer" class="menu-item depth-3">
    
    
        Data Transfer
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_vm" class="menu-item depth-2">
    💻
    
        <strong>Virtual Machine</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_vm__actor" class="menu-item depth-3">
    
    
        Actor
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_vm__actor__address" class="menu-item depth-4">
    
    
        Address
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_vm__state_tree" class="menu-item depth-3">
    
    
        State Tree
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_vm__message" class="menu-item depth-3">
    
    
        Message
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_vm__runtime" class="menu-item depth-3">
    
    
        Runtime
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_vm__runtime__exitcode" class="menu-item depth-4">
    
    
        Exit Codes
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_vm__runtime__gascost" class="menu-item depth-4">
    
    
        Gas Costs
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_vm__sysactors" class="menu-item depth-3">
    
    
        System Actors
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_vm__sysactors__init_actor" class="menu-item depth-4">
    
    
        InitActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_vm__sysactors__cron_actor" class="menu-item depth-4">
    
    
        CronActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_vm__sysactors__account_actor" class="menu-item depth-4">
    
    
        AccountActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_vm__sysactors__reward_actor" class="menu-item depth-4">
    
    
        RewardActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_vm__interpreter" class="menu-item depth-3">
    
    
        Interpreter
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain" class="menu-item depth-2">
    📦
    
        <strong>Blockchain</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__struct" class="menu-item depth-3">
    
    
        Blocks
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__struct__block" class="menu-item depth-4">
    
    
        Block
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__struct__tipset" class="menu-item depth-4">
    
    
        Tipset
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__struct__chain" class="menu-item depth-4">
    
    
        Chain
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__struct__chain_manager" class="menu-item depth-4">
    
    
        Chain Manager
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__struct__block_producer" class="menu-item depth-4">
    
    
        Block Producer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__message_pool" class="menu-item depth-3">
    
    
        Message Pool
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__message_pool__message_syncer" class="menu-item depth-4">
    
    
        Message Syncer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__message_pool__message_storage" class="menu-item depth-4">
    
    
        Message Storage
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_blockchain__chainsync" class="menu-item depth-3">
    
    
        ChainSync
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__storage_power_consensus" class="menu-item depth-3">
    
    
        Storage Power Consensus
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor" class="menu-item depth-4">
    
    
        Storage Power Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_token" class="menu-item depth-2">
    📀
    
        <strong>Token</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_token__wallets" class="menu-item depth-3">
    
    
        Wallet
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_token__payments" class="menu-item depth-3">
    
    
        Payments
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_token__payment_channels" class="menu-item depth-3">
    
    
        Payment Channels
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_token__payment_channels__payment_channel_actor" class="menu-item depth-4">
    
    
        Payment Channel Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_token__multisig" class="menu-item depth-3">
    
    
        Multisig Wallet
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_token__multisig__multisig_actor" class="menu-item depth-4">
    
    
        Multisig Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_mining" class="menu-item depth-2">
    ⛏
    
        <strong>Storage Mining</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_mining__storage_mining" class="menu-item depth-3">
    
    
        Storage Miner
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__storage_mining__mining_cycle" class="menu-item depth-4">
    
    
        Storage Mining Cycle
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__storage_mining__storage_miner_actor" class="menu-item depth-4">
    
    
        Storage Miner Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__sector" class="menu-item depth-3">
    
    
        Sector
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__sector__sectorset" class="menu-item depth-4">
    
    
        Sector Set
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__sector__sealing" class="menu-item depth-4">
    
    
        Sector Sealing
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__sector_index" class="menu-item depth-3">
    
    
        Sector Index
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__sector_index__sector_builder" class="menu-item depth-4">
    
    
        Sector Builder
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__sector_index__sector_store" class="menu-item depth-4">
    
    
        SectorStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_mining__storage_proving" class="menu-item depth-3">
    
    
        Storage Proving
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_mining__storage_proving__sealer" class="menu-item depth-4">
    
    
        Sector Sealer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_mining__storage_proving__poster" class="menu-item depth-4">
    
    
        Sector Poster
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_markets" class="menu-item depth-2">
    ⚖️
    
        <strong>Market</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_markets__order" class="menu-item depth-3">
    
    
        Orders
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_markets__deal" class="menu-item depth-3">
    
    
        Deals
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_markets__storage_market" class="menu-item depth-3">
    
    
        Storage Market
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__storage_market__storage_market_actor" class="menu-item depth-4">
    
    
        Storage Market Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__storage_market__storage_provider" class="menu-item depth-4">
    
    
        Storage Provider
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__storage_market__storage_client" class="menu-item depth-4">
    
    
        Storage Client
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__storage_market__faults" class="menu-item depth-4">
    
    
        Faults
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#systems__filecoin_markets__retrieval_market" class="menu-item depth-3">
    
    
        Retrieval Market
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__retrieval_market__retrieval_peer_resolver" class="menu-item depth-4">
    
    
        Retrieval Peer Resolver
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__retrieval_market__retrieval_protocols" class="menu-item depth-4">
    
    
        Retrieval Protocols
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__retrieval_market__retrieval_client" class="menu-item depth-4">
    
    
        Retrieval Client
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#systems__filecoin_markets__retrieval_market__retrieval_provider" class="menu-item depth-4">
    
    
        Retrieval Provider (Miner)
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        










  


<a href="../../../../../#libraries" class="menu-item depth-1">
    
    
    <strong>
    
        Libraries
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
    </li>

    <li>
    
      











<a href="../../../../../#libraries__fcs" class="menu-item depth-2">
    
    
        FCS
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__ipld" class="menu-item depth-2">
    
    
        IPLD
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#libraries__ipld__cid" class="menu-item depth-3">
    
    
        CID
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#libraries__ipld__datamodel" class="menu-item depth-3">
    
    
        Data Model
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__ipld__selectors" class="menu-item depth-3">
    
    
        Selectors
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__ipld__graphstore" class="menu-item depth-3">
    
    
        GraphStore
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__libp2p" class="menu-item depth-2">
    
    
        libp2p
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../../#libraries__libp2p__gossipsub" class="menu-item depth-3">
    
    
        gossipsub
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__libp2p__kad_dht" class="menu-item depth-3">
    
    
        kad-dht
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__libp2p__fil_libp2p_nodes" class="menu-item depth-3">
    
    
        fil-libp2p Nodes
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__ipfs" class="menu-item depth-2">
    
    
        IPFS
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../../#libraries__ipfs__bitswap" class="menu-item depth-3">
    
    
        BitSwap
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#libraries__ipfs__graphsync" class="menu-item depth-3">
    
    
        GraphSync
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#libraries__ipfs__unixfs" class="menu-item depth-3">
    
    
        UnixFS
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../../#libraries__multiformats" class="menu-item depth-2">
    
    
        Multiformats
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../../#algorithms" class="menu-item depth-1">
    
    
    <strong>
    
        Algorithms
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../../#algorithms__expected_consensus" class="menu-item depth-2">
    
    
        Expected Consensus
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__porep" class="menu-item depth-2">
    
    
        Proof-of-Replication
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../../#algorithms__porep__stacked_drg" class="menu-item depth-3">
    
    
        Stacked DRG PoRep
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__porep__porep_commitments" class="menu-item depth-3">
    
    
        PoRep Commitments
    
</a>




    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__porep__stacked_drg_circuit" class="menu-item depth-3">
    
    
        
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__post" class="menu-item depth-2">
    
    
        Proof-of-Spacetime
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../../#algorithms__post__election_post" class="menu-item depth-3">
    
    
        Election PoSt
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__post__proof_of_spacetime_parameters" class="menu-item depth-3">
    
    
        PoSt Parameters
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__payment_channels" class="menu-item depth-2">
    
    
        Payment Channels
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__block_sync" class="menu-item depth-2">
    
    
        BlockSync
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__gossip_sub" class="menu-item depth-2">
    
    
        GossipSub
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#algorithms__crypto" class="menu-item depth-2">
    
    
        Cryptographic Primitives
    
</a>




    
    </li>

    <li>
    
      










  


<a href="../../../../../#algorithms__cryptoecon" class="menu-item depth-2">
    
    
        Cryptoecon
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../../#listings" class="menu-item depth-1">
    
    
    <strong>
    
        Listings
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../../#listings__actors" class="menu-item depth-2">
    
    
        Filecoin VM Actors
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#listings__data_structures" class="menu-item depth-2">
    
    
        Data Structures
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#listings__system_map" class="menu-item depth-2">
    
    
        Components
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#listings__libp2p_protocols" class="menu-item depth-2">
    
    
        libp2p Protocols
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../../#listings__libp2p_protocols__data_transfer_protocol" class="menu-item depth-3">
    
    
        Data Transfer Protocol
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../../#glossary" class="menu-item depth-1">
    
    
    <strong>
    
        Glossary
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../../#appendix" class="menu-item depth-1">
    
    
    <strong>
    
        Appendix
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../../#appendix__sharray" class="menu-item depth-2">
    
    
        Sharded IPLD Array
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#appendix__address" class="menu-item depth-2">
    
    
        Address
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../../#appendix__orient" class="menu-item depth-2">
    
    
        Filecoin Parameters
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
  </ul>
  
</div>










</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="../../../../../svg/menu.svg" alt="Menu" />
  </label>
  <strong>Storage Miner Actor</strong>
</header>

      
<article class="markdown">
  

<div id="systems__filecoin_mining__storage_mining__storage_miner_actor__storage_miner_actor"></div>

<p>(You can see the <em>old</em> Storage Miner Actor <a href="docs/systems/filecoin_mining/storage_mining/storage_miner_actor_old">here</a> )</p>

<h1 id="storagemineractor-interface"><code>StorageMinerActor</code> interface</h1>




















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">libp2p</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/libp2p&#34;</span>
<span class="kn">import</span> <span class="nx">sealing</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
<span class="kn">import</span> <span class="nx">sector</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
<span class="kn">import</span> <span class="nx">address</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor/address&#34;</span>
<span class="kn">import</span> <span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
<span class="kn">import</span> <span class="nx">deal</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_markets/deal&#34;</span>
<span class="kn">import</span> <span class="nx">actor</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor&#34;</span>
<span class="kn">import</span> <span class="nx">stateTree</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
<span class="kn">import</span> <span class="nx">spc</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/storage_power_consensus&#34;</span>

<span class="kd">type</span> <span class="nx">SectorExpirationQueueItem</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">SectorNumber</span>  <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span>
    <span class="nx">Expiration</span>    <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">SectorExpirationQueue</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nf">Add</span><span class="p">(</span><span class="nx">i</span> <span class="nx">SectorExpirationQueueItem</span><span class="p">)</span>
    <span class="nf">Pop</span><span class="p">()</span> <span class="nx">SectorExpirationQueueItem</span>
    <span class="nf">Peek</span><span class="p">()</span> <span class="nx">SectorExpirationQueueItem</span>
    <span class="nf">Remove</span><span class="p">(</span><span class="nx">n</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">SectorTable</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">SectorSize</span>         <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorSize</span>
    <span class="nx">ActiveSectors</span>      <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>
    <span class="nx">CommittedSectors</span>   <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>
    <span class="nx">RecoveringSectors</span>  <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>
    <span class="nx">FailingSectors</span>     <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>

    <span class="c1">// transient State that get reset on every constructPowerReport
</span><span class="c1"></span>    <span class="nx">TerminatedFaults</span>   <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">StagedCommittedSectorInfo</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Sector</span>       <span class="nx">SectorOnChainInfo</span>
    <span class="nx">Utilization</span>  <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">SectorOnChainInfo</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">SealCommitment</span>  <span class="nx">sector</span><span class="p">.</span><span class="nx">SealCommitment</span>
    <span class="nx">State</span>           <span class="nx">SectorState</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">ChallengeStatus</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">LastChallengeEpoch</span>     <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>  <span class="c1">// get updated by NotifyOfPoStSurpriseChallenge and SubmitElectionPoSt
</span><span class="c1"></span>    <span class="nx">_lastPoStFailureEpoch</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>  <span class="c1">// get updated upon _onMissedSurprisePoSt
</span><span class="c1"></span>    <span class="nx">_lastPoStSuccessEpoch</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>  <span class="c1">// get updated by successful Election or Suprise PoSt submission
</span><span class="c1"></span>
    <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">spc</span><span class="p">.</span><span class="nx">StoragePowerActorState</span>

    <span class="nf">OnNewChallenge</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span>
    <span class="nf">LastPoStResponseEpoch</span><span class="p">()</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
    <span class="nf">OnPoStSuccess</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span>
    <span class="nf">OnPoStFailure</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span>

    <span class="nf">IsChallenged</span><span class="p">()</span> <span class="kt">bool</span>  <span class="c1">// only True when proving SurprisePoSt (implicit because ElectionPoSt completes within a block)
</span><span class="c1"></span>    <span class="nf">ChallengeHasExpired</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">CanBeElected</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">ShouldChallenge</span><span class="p">(</span>
        <span class="nx">currEpoch</span>            <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
        <span class="nx">challengeFreePeriod</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
    <span class="p">)</span> <span class="kt">bool</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">PreCommittedSector</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">Info</span>           <span class="nx">sealing</span><span class="p">.</span><span class="nx">SectorPreCommitInfo</span>
    <span class="nx">ReceivedEpoch</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">PreCommittedSectorsAMT</span> <span class="p">{</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">:</span> <span class="nx">PreCommittedSector</span><span class="p">}</span>
<span class="kd">type</span> <span class="nx">StagedCommittedSectorAMT</span> <span class="p">{</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">:</span> <span class="nx">StagedCommittedSectorInfo</span><span class="p">}</span>
<span class="kd">type</span> <span class="nx">SectorsAMT</span> <span class="p">{</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">:</span> <span class="nx">SectorOnChainInfo</span><span class="p">}</span>

<span class="c1">// map from SectorNumber to amout of storage in active deals
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">SectorUtilizationAMT</span> <span class="p">{</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">:</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span><span class="p">}</span>

<span class="c1">// Balance of a StorageMinerActor should equal exactly the sum of PreCommit deposits that are not yet returned or burned
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">StorageMinerActorState</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">PreCommittedSectors</span>     <span class="nx">PreCommittedSectorsAMT</span>
    <span class="nx">StagedCommittedSectors</span>  <span class="nx">StagedCommittedSectorAMT</span>
    <span class="nx">Sectors</span>                 <span class="nx">SectorsAMT</span>
    <span class="nx">SectorUtilization</span>       <span class="nx">SectorUtilizationAMT</span>
    <span class="nx">ProvingSet</span>              <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>

    <span class="nx">SectorTable</span>
    <span class="nx">SectorExpirationQueue</span>
    <span class="nx">ChallengeStatus</span>

    <span class="c1">// contains mostly static info about this miner
</span><span class="c1"></span>    <span class="nx">Info</span>                    <span class="o">&amp;</span><span class="nx">MinerInfo</span>

    <span class="c1">// No DeclareFaults and CommitSector can happen when SM is in the isChallenged state
</span><span class="c1"></span>    <span class="nf">_isChallenged</span><span class="p">()</span>         <span class="kt">bool</span>
    <span class="nf">_canBeElected</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">_challengeHasExpired</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">_shouldChallenge</span><span class="p">(</span>
        <span class="nx">currEpoch</span>            <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
        <span class="nx">challengeFreePeriod</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
    <span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">_verifySeal</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainSealVerifyInfo</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">_assertSectorDidNotExist</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span>

    <span class="nf">_processStagedCommittedSectors</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>
    <span class="nf">_updateFailSector</span><span class="p">(</span>
        <span class="nx">rt</span>                   <span class="nx">Runtime</span>
        <span class="nx">sectorNo</span>             <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span>
        <span class="nx">incrementFaultCount</span>  <span class="kt">bool</span>
    <span class="p">)</span>
    <span class="nf">_updateExpireSectors</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>
    <span class="nf">_updateClearSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span>
    <span class="nf">_updateActivateSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span>
    <span class="nf">_updateSectorUtilization</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">lastPoStResponse</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="p">[</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealID</span><span class="p">]</span>
    <span class="nf">_initializeUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">deals</span> <span class="p">[</span><span class="nx">deal</span><span class="p">.</span><span class="nx">OnChainDeal</span><span class="p">])</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span>

    <span class="nf">_getActivePower</span><span class="p">()</span>    <span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">_getInactivePower</span><span class="p">()</span>  <span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">_safeGetUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span>
    <span class="nf">_getUtilizationInfo</span><span class="p">(</span><span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span> <span class="p">(</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
    <span class="nf">_getPreCommitDepositReq</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="nx">actor</span><span class="p">.</span><span class="nx">TokenAmount</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">StorageMinerActorCode</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nf">NotifyOfSurprisePoStChallenge</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>

    <span class="nf">PreCommitSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">info</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorPreCommitInfo</span><span class="p">)</span>  <span class="c1">// TODO: check with Magik on sizes
</span><span class="c1"></span>    <span class="nf">ProveCommitSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">info</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorProveCommitInfo</span><span class="p">)</span>

    <span class="nf">SubmitVerifiedSurprisePoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span>
    <span class="nf">SubmitVerifiedElectionPoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span>

    <span class="nf">_checkSurprisePoStSubmissionHappened</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>

    <span class="nf">DeclareFaults</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">failingSet</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span><span class="p">)</span>
    <span class="nf">RecoverFaults</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">recoveringSet</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span><span class="p">)</span>

    <span class="nf">_isChallenged</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">_isSealVerificationCorrect</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainSealVerifyInfo</span><span class="p">)</span> <span class="kt">bool</span>
    <span class="nf">_onMissedSurprisePoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>
    <span class="nf">_onSuccessfulPoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span>

    <span class="nf">_slashCollateralForStorageFaults</span><span class="p">(</span>
        <span class="nx">rt</span>          <span class="nx">Runtime</span>
        <span class="nx">declared</span>    <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>  <span class="c1">// diff value
</span><span class="c1"></span>        <span class="nx">detected</span>    <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>  <span class="c1">// diff value
</span><span class="c1"></span>        <span class="nx">terminated</span>  <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span>  <span class="c1">// diff value
</span><span class="c1"></span>    <span class="p">)</span>
    <span class="nf">_slashDealsForStorageFault</span><span class="p">(</span>
        <span class="nx">rt</span>             <span class="nx">Runtime</span>
        <span class="nx">sectorNumbers</span>  <span class="p">[</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">]</span>
        <span class="nx">faultType</span>      <span class="nx">sector</span><span class="p">.</span><span class="nx">StorageFaultType</span>
    <span class="p">)</span>

    <span class="nf">_claimDealPayments</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>
    <span class="nf">_submitPowerReport</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">lastPoSt</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span>
    <span class="nf">_expirePreCommittedSectors</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>
    <span class="nf">_ensurePledgeCollateralSatisfied</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">MinerInfo</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="c1">// Account that owns this miner.
</span><span class="c1"></span>    <span class="c1">// - Income and returned collateral are paid to this address.
</span><span class="c1"></span>    <span class="c1">// - This address is also allowed to change the worker address for the miner.
</span><span class="c1"></span>    <span class="nx">Owner</span>                   <span class="nx">address</span><span class="p">.</span><span class="nx">Address</span>

    <span class="c1">// Worker account for this miner.
</span><span class="c1"></span>    <span class="c1">// This will be the key that is used to sign blocks created by this miner, and
</span><span class="c1"></span>    <span class="c1">// sign messages sent on behalf of this miner to commit sectors, submit PoSts, and
</span><span class="c1"></span>    <span class="c1">// other day to day miner activities.
</span><span class="c1"></span>    <span class="nx">Worker</span>                  <span class="nx">address</span><span class="p">.</span><span class="nx">Address</span>

    <span class="c1">// Libp2p identity that should be used when connecting to this miner.
</span><span class="c1"></span>    <span class="nx">PeerId</span>                  <span class="nx">libp2p</span><span class="p">.</span><span class="nx">PeerID</span>

    <span class="c1">// Amount of space in each sector committed to the network by this miner.
</span><span class="c1"></span>    <span class="nx">SectorSize</span>              <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorSize</span>
    <span class="nx">WindowCount</span>             <span class="nx">UVarint</span>
    <span class="nx">SealPartitions</span>          <span class="nx">UVarint</span>
    <span class="nx">ElectionPoStPartitions</span>  <span class="nx">UVarint</span>
    <span class="nx">SurprisePoStPartitions</span>  <span class="nx">UVarint</span>
<span class="p">}</span>
</code></pre></div>






<h1 id="storagemineractorstate-implementation"><code>StorageMinerActorState</code> implementation</h1>




















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">storage_mining</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="s">&#34;errors&#34;</span>

    <span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
    <span class="nx">deal</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_markets/deal&#34;</span>
    <span class="nx">sector</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
    <span class="nx">actor</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor&#34;</span>
    <span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor/address&#34;</span>
    <span class="nx">st</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
    <span class="nx">util</span> <span class="s">&#34;github.com/filecoin-project/specs/util&#34;</span>
<span class="p">)</span>

<span class="kd">var</span> <span class="nx">Assert</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Assert</span>

<span class="c1">// Get the owner account address associated to a given miner actor.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GetMinerOwnerAddress</span><span class="p">(</span><span class="nx">tree</span> <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">minerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="p">(</span><span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Get the owner account address associated to a given miner actor.
</span><span class="c1"></span><span class="kd">func</span> <span class="nf">GetMinerOwnerAddress_Assert</span><span class="p">(</span><span class="nx">tree</span> <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">a</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span> <span class="p">{</span>
    <span class="nx">ret</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">GetMinerOwnerAddress</span><span class="p">(</span><span class="nx">tree</span><span class="p">,</span> <span class="nx">a</span><span class="p">)</span>
    <span class="nf">Assert</span><span class="p">(</span><span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_isChallenged</span><span class="p">()</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">IsChallenged</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_canBeElected</span><span class="p">(</span><span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">CanBeElected</span><span class="p">(</span><span class="nx">epoch</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_challengeHasExpired</span><span class="p">(</span><span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">ChallengeHasExpired</span><span class="p">(</span><span class="nx">epoch</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">ShouldChallenge</span><span class="p">(</span><span class="nx">currEpoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">,</span> <span class="nx">challengeFreePeriod</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">ShouldChallenge</span><span class="p">(</span><span class="nx">currEpoch</span><span class="p">,</span> <span class="nx">challengeFreePeriod</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_processStagedCommittedSectors</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">for</span> <span class="nx">sectorNo</span><span class="p">,</span> <span class="nx">stagedInfo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">st</span><span class="p">.</span><span class="nf">StagedCommittedSectors</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">]</span> <span class="p">=</span> <span class="nx">stagedInfo</span><span class="p">.</span><span class="nf">Sector</span><span class="p">()</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">CommittedSectors_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorUtilization</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">]</span> <span class="p">=</span> <span class="nx">stagedInfo</span><span class="p">.</span><span class="nf">Utilization</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="c1">// empty StagedCommittedSectors
</span><span class="c1"></span>    <span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">StagedCommittedSectors_</span> <span class="p">=</span> <span class="nb">make</span><span class="p">(</span><span class="kd">map</span><span class="p">[</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">]</span><span class="nx">StagedCommittedSectorInfo</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_updateSectorUtilization</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">lastPoStResponse</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="p">[]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealID</span> <span class="p">{</span>
    <span class="c1">// TODO: verify if we should update Sector utilization for failing sectors
</span><span class="c1"></span>    <span class="c1">// depends on decision around collateral requirement for inactive power
</span><span class="c1"></span>    <span class="c1">// and what happens when a failing sector expires
</span><span class="c1"></span>
    <span class="nx">ret</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">utilizationInfo</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_safeGetUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">newUtilization</span> <span class="o">:=</span> <span class="nx">utilizationInfo</span><span class="p">.</span><span class="nf">CurrUtilization</span><span class="p">()</span>

        <span class="nx">currEpoch</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">()</span>
        <span class="nx">newExpiredDealIDs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nx">newExpiredDeals</span> <span class="o">:=</span> <span class="nx">utilizationInfo</span><span class="p">.</span><span class="nf">DealExpirationAMT</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">ExpiredDealsInRange</span><span class="p">(</span><span class="nx">lastPoStResponse</span><span class="p">,</span> <span class="nx">currEpoch</span><span class="p">)</span>

        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">expiredDeal</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">newExpiredDeals</span> <span class="p">{</span>
            <span class="nx">expiredPower</span> <span class="o">:=</span> <span class="nx">expiredDeal</span><span class="p">.</span><span class="nf">Power</span><span class="p">()</span>
            <span class="nx">newUtilization</span> <span class="o">-=</span> <span class="nx">expiredPower</span>
            <span class="nx">newExpiredDealIDs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">newExpiredDealIDs</span><span class="p">,</span> <span class="nx">expiredDeal</span><span class="p">.</span><span class="nf">ID</span><span class="p">())</span>
        <span class="p">}</span>

        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorUtilization</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">CurrUtilization_</span> <span class="p">=</span> <span class="nx">newUtilization</span>
        <span class="nx">ret</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">newExpiredDealIDs</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">ret</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_getActivePower</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">activePower</span> <span class="o">:=</span> <span class="nx">block</span><span class="p">.</span><span class="nf">StoragePower</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ActiveSectors_</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">utilInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getUtilizationInfo</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">block</span><span class="p">.</span><span class="nf">StoragePower</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="nx">activePower</span> <span class="o">+=</span> <span class="nx">utilInfo</span><span class="p">.</span><span class="nf">CurrUtilization</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">activePower</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_getInactivePower</span><span class="p">()</span> <span class="p">(</span><span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">inactivePower</span> <span class="p">=</span> <span class="nx">block</span><span class="p">.</span><span class="nf">StoragePower</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1">// iterate over sectorNo in CommittedSectors, RecoveringSectors, and FailingSectors
</span><span class="c1"></span>    <span class="nx">inactiveProvingSet</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">CommittedSectors_</span><span class="p">.</span><span class="nf">Extend</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">RecoveringSectors</span><span class="p">())</span>
    <span class="nx">inactiveSectorSet</span> <span class="o">:=</span> <span class="nx">inactiveProvingSet</span><span class="p">.</span><span class="nf">Extend</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">FailingSectors</span><span class="p">())</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">inactiveSectorSet</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">utilizationInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getUtilizationInfo</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nx">block</span><span class="p">.</span><span class="nf">StoragePower</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nx">err</span>
        <span class="p">}</span>
        <span class="nx">inactivePower</span> <span class="o">+=</span> <span class="nx">utilizationInfo</span><span class="p">.</span><span class="nf">CurrUtilization</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">inactivePower</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="c1">// move Sector from Active/Failing
</span><span class="c1">// into Cleared State which means deleting the Sector from state
</span><span class="c1">// remove SectorNumber from all states on chain
</span><span class="c1">// update SectorTable
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_updateClearSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sectorState</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">State</span><span class="p">()</span>
    <span class="k">switch</span> <span class="nx">sectorState</span><span class="p">.</span><span class="nx">StateNumber</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">SectorActiveSN</span><span class="p">:</span>
        <span class="c1">// expiration case
</span><span class="c1"></span>        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ActiveSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">SectorFailingSN</span><span class="p">:</span>
        <span class="c1">// expiration and termination cases
</span><span class="c1"></span>        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">FailingSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="c1">// Committed and Recovering should not go to Cleared directly
</span><span class="c1"></span>        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;invalid state in clearSector&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nb">delete</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">(),</span> <span class="nx">sectorNo</span><span class="p">)</span>
    <span class="nb">delete</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">SectorUtilization</span><span class="p">(),</span> <span class="nx">sectorNo</span><span class="p">)</span>
    <span class="nx">st</span><span class="p">.</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">SectorExpirationQueue</span><span class="p">().</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// move Sector from Committed/Recovering into Active State
</span><span class="c1">// reset FaultCount to zero
</span><span class="c1">// update SectorTable
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_updateActivateSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">sectorState</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">State</span><span class="p">()</span>
    <span class="k">switch</span> <span class="nx">sectorState</span><span class="p">.</span><span class="nx">StateNumber</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">SectorCommittedSN</span><span class="p">:</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">CommittedSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">SectorRecoveringSN</span><span class="p">:</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">RecoveringSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;sm._updateActivateSector: invalid state in activateSector&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">State_</span> <span class="p">=</span> <span class="nf">SectorActive</span><span class="p">()</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ActiveSectors_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// failSector moves Sector from Active/Committed/Recovering into Failing State
</span><span class="c1">// and increments FaultCount if asked to do so (DeclareFaults does not increment faultCount)
</span><span class="c1">// move Sector from Failing to Cleared State if increment results in faultCount exceeds MaxFaultCount
</span><span class="c1">// update SectorTable
</span><span class="c1">// remove from ProvingSet
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_updateFailSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">,</span> <span class="nx">increment</span> <span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">newFaultCount</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">State</span><span class="p">().</span><span class="nx">FaultCount</span>

    <span class="k">if</span> <span class="nx">increment</span> <span class="p">{</span>
        <span class="nx">newFaultCount</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="p">}</span>

    <span class="nx">state</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">State</span><span class="p">()</span>
    <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">StateNumber</span> <span class="p">{</span>
    <span class="k">case</span> <span class="nx">SectorActiveSN</span><span class="p">:</span>
        <span class="c1">// wont be terminated from Active
</span><span class="c1"></span>        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ActiveSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">FailingSectors_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">State_</span> <span class="p">=</span> <span class="nf">SectorFailing</span><span class="p">(</span><span class="nx">newFaultCount</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">SectorCommittedSN</span><span class="p">:</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">CommittedSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">FailingSectors_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">State_</span> <span class="p">=</span> <span class="nf">SectorFailing</span><span class="p">(</span><span class="nx">newFaultCount</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">SectorRecoveringSN</span><span class="p">:</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">RecoveringSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">FailingSectors_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">State_</span> <span class="p">=</span> <span class="nf">SectorFailing</span><span class="p">(</span><span class="nx">newFaultCount</span><span class="p">)</span>
    <span class="k">case</span> <span class="nx">SectorFailingSN</span><span class="p">:</span>
        <span class="c1">// no change to SectorTable but increase in FaultCount
</span><span class="c1"></span>        <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">State_</span> <span class="p">=</span> <span class="nf">SectorFailing</span><span class="p">(</span><span class="nx">newFaultCount</span><span class="p">)</span>
    <span class="k">default</span><span class="p">:</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Invalid sector state in CronAction&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">newFaultCount</span> <span class="p">&gt;</span> <span class="nx">MAX_CONSECUTIVE_FAULTS</span> <span class="p">{</span>
        <span class="c1">// slashing is done at _slashCollateralForStorageFaults
</span><span class="c1"></span>        <span class="nx">st</span><span class="p">.</span><span class="nf">_updateClearSector</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">TerminatedFaults_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_updateExpireSectors</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">currEpoch</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">()</span>

    <span class="nx">queue</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorExpirationQueue</span><span class="p">()</span>
    <span class="k">for</span> <span class="nx">queue</span><span class="p">.</span><span class="nf">Peek</span><span class="p">().</span><span class="nf">Expiration</span><span class="p">()</span> <span class="o">&lt;=</span> <span class="nx">currEpoch</span> <span class="p">{</span>
        <span class="nx">expiredSectorNo</span> <span class="o">:=</span> <span class="nx">queue</span><span class="p">.</span><span class="nf">Pop</span><span class="p">().</span><span class="nf">SectorNumber</span><span class="p">()</span>

        <span class="nx">state</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">expiredSectorNo</span><span class="p">].</span><span class="nf">State</span><span class="p">()</span>

        <span class="k">switch</span> <span class="nx">state</span><span class="p">.</span><span class="nx">StateNumber</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">SectorActiveSN</span><span class="p">:</span>
            <span class="c1">// Note: in order to verify if something was stored in the past, one must
</span><span class="c1"></span>            <span class="c1">// scan the chain. SectorNumber can be re-used.
</span><span class="c1"></span>
            <span class="c1">// expiration settlement will be done at _updateSectorUtilization
</span><span class="c1"></span>            <span class="nx">st</span><span class="p">.</span><span class="nf">_updateClearSector</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">expiredSectorNo</span><span class="p">)</span>
        <span class="k">case</span> <span class="nx">SectorFailingSN</span><span class="p">:</span>
            <span class="c1">// TODO: check if there is any fault that we should handle here
</span><span class="c1"></span>
            <span class="c1">// a failing sector expires, no change to FaultCount
</span><span class="c1"></span>            <span class="c1">// expiration settlement will be done at _updateSectorUtilization
</span><span class="c1"></span>            <span class="nx">st</span><span class="p">.</span><span class="nf">_updateClearSector</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">expiredSectorNo</span><span class="p">)</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="c1">// Note: SectorCommittedSN, SectorRecoveringSN transition first to SectorFailingSN, then expire
</span><span class="c1"></span>            <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Invalid sector state in SectorExpirationQueue&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_assertSectorDidNotExist</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">_</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">]</span>
    <span class="k">if</span> <span class="nx">found</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;sm._assertSectorDidNotExist: sector already exists.&#34;</span><span class="p">)</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_safeGetUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span> <span class="p">{</span>
    <span class="nx">utilizationInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getUtilizationInfo</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">utilizationInfo</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_getUtilizationInfo</span><span class="p">(</span><span class="nx">sectorNo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">)</span> <span class="p">(</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">utilizationInfo</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorUtilization</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">]</span>

    <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
        <span class="nx">err</span> <span class="o">:=</span> <span class="nx">errors</span><span class="p">.</span><span class="nf">New</span><span class="p">(</span><span class="s">&#34;sm._getUtilizationInfo: utilization info not found.&#34;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">nil</span><span class="p">,</span> <span class="nx">err</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">utilizationInfo</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_initializeUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">deals</span> <span class="p">[]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">OnChainDeal</span><span class="p">)</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">maxUtilization</span> <span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span>
    <span class="kd">var</span> <span class="nx">dealExpirationAMT</span> <span class="nx">deal</span><span class="p">.</span><span class="nx">DealExpirationAMT</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">d</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">deals</span> <span class="p">{</span>
        <span class="nx">dealID</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">ID</span><span class="p">()</span>
        <span class="nx">dealExpiration</span> <span class="o">:=</span> <span class="nx">d</span><span class="p">.</span><span class="nf">Deal</span><span class="p">().</span><span class="nf">Proposal</span><span class="p">().</span><span class="nf">EndEpoch</span><span class="p">()</span>
        <span class="c1">// TODO: verify what counts towards power here
</span><span class="c1"></span>        <span class="c1">// There is PayloadSize, OverheadSize, and Total, see piece.id
</span><span class="c1"></span>        <span class="nx">dealPayloadPower</span> <span class="o">:=</span> <span class="nx">block</span><span class="p">.</span><span class="nf">StoragePower</span><span class="p">(</span><span class="nx">d</span><span class="p">.</span><span class="nf">Deal</span><span class="p">().</span><span class="nf">Proposal</span><span class="p">().</span><span class="nf">PieceSize</span><span class="p">().</span><span class="nf">PayloadSize</span><span class="p">())</span>

        <span class="nx">expirationValue</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealExpirationValue_I</span><span class="p">{</span>
            <span class="nx">ID_</span><span class="p">:</span>    <span class="nx">dealID</span><span class="p">,</span>
            <span class="nx">Power_</span><span class="p">:</span> <span class="nx">dealPayloadPower</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="nx">dealExpirationAMT</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="nx">dealExpiration</span><span class="p">,</span> <span class="nx">expirationValue</span><span class="p">)</span>

        <span class="nx">maxUtilization</span> <span class="o">+=</span> <span class="nx">dealPayloadPower</span>

    <span class="p">}</span>

    <span class="nx">initialUtilizationInfo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorUtilizationInfo_I</span><span class="p">{</span>
        <span class="nx">DealExpirationAMT_</span><span class="p">:</span> <span class="nx">dealExpirationAMT</span><span class="p">,</span>
        <span class="nx">MaxUtilization_</span><span class="p">:</span>    <span class="nx">maxUtilization</span><span class="p">,</span>
        <span class="nx">CurrUtilization_</span><span class="p">:</span>   <span class="nx">maxUtilization</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">initialUtilizationInfo</span>

<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">_getPreCommitDepositReq</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="nx">actor</span><span class="p">.</span><span class="nx">TokenAmount</span> <span class="p">{</span>

    <span class="c1">// TODO: move this to Construct
</span><span class="c1"></span>    <span class="nx">minerInfo</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Info</span><span class="p">()</span>
    <span class="nx">sectorSize</span> <span class="o">:=</span> <span class="nx">minerInfo</span><span class="p">.</span><span class="nf">SectorSize</span><span class="p">()</span>
    <span class="nx">depositReq</span> <span class="o">:=</span> <span class="nx">actor</span><span class="p">.</span><span class="nf">TokenAmount</span><span class="p">(</span><span class="nb">uint64</span><span class="p">(</span><span class="nx">PRECOMMIT_DEPOSIT_PER_BYTE</span><span class="p">)</span> <span class="o">*</span> <span class="nb">uint64</span><span class="p">(</span><span class="nx">sectorSize</span><span class="p">))</span>

    <span class="k">return</span> <span class="nx">depositReq</span>
<span class="p">}</span>
</code></pre></div>






<h1 id="storagemineractorcode-implementation"><code>StorageMinerActorCode</code> implementation</h1>




















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">storage_mining</span>

<span class="kn">import</span> <span class="p">(</span>
    <span class="nx">filproofs</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/filcrypto/filproofs&#34;</span>
    <span class="nx">ipld</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/ipld&#34;</span>
    <span class="nx">spc</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/storage_power_consensus&#34;</span>
    <span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
    <span class="nx">deal</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_markets/deal&#34;</span>
    <span class="nx">market</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_markets/storage_market&#34;</span>
    <span class="nx">sector</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
    <span class="nx">actor</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor&#34;</span>
    <span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor/address&#34;</span>
    <span class="nx">vmr</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/runtime&#34;</span>
    <span class="nx">exitcode</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/runtime/exitcode&#34;</span>
    <span class="nx">sys</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/sysactors&#34;</span>
    <span class="nx">util</span> <span class="s">&#34;github.com/filecoin-project/specs/util&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="p">(</span>
    <span class="nx">Method_StorageMinerActor_SubmitSurprisePoSt</span> <span class="p">=</span> <span class="nx">actor</span><span class="p">.</span><span class="nx">MethodPlaceholder</span> <span class="o">+</span> <span class="kc">iota</span>
<span class="p">)</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1">// Boilerplate
</span><span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1"></span><span class="kd">type</span> <span class="nx">State</span> <span class="p">=</span> <span class="nx">StorageMinerActorState</span>
<span class="kd">type</span> <span class="nx">Any</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Any</span>
<span class="kd">type</span> <span class="nx">Bool</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Bool</span>
<span class="kd">type</span> <span class="nx">Bytes</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Bytes</span>
<span class="kd">type</span> <span class="nx">InvocOutput</span> <span class="p">=</span> <span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocOutput</span>
<span class="kd">type</span> <span class="nx">Runtime</span> <span class="p">=</span> <span class="nx">vmr</span><span class="p">.</span><span class="nx">Runtime</span>

<span class="kd">var</span> <span class="nx">TODO</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">TODO</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">State</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">(</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">ActorStateHandle</span><span class="p">,</span> <span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">h</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">AcquireState</span><span class="p">()</span>
    <span class="nx">stateCID</span> <span class="o">:=</span> <span class="nx">h</span><span class="p">.</span><span class="nf">Take</span><span class="p">()</span>
    <span class="nx">stateBytes</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">IpldGet</span><span class="p">(</span><span class="nx">ipld</span><span class="p">.</span><span class="nf">CID</span><span class="p">(</span><span class="nx">stateCID</span><span class="p">))</span>
    <span class="k">if</span> <span class="nx">stateBytes</span><span class="p">.</span><span class="nf">Which</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">vmr</span><span class="p">.</span><span class="nx">Runtime_IpldGet_FunRet_Case_Bytes</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortAPI</span><span class="p">(</span><span class="s">&#34;IPLD lookup error&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">state</span> <span class="o">:=</span> <span class="nf">DeserializeState</span><span class="p">(</span><span class="nx">stateBytes</span><span class="p">.</span><span class="nf">As_Bytes</span><span class="p">())</span>
    <span class="k">return</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">state</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">h</span> <span class="nx">vmr</span><span class="p">.</span><span class="nx">ActorStateHandle</span><span class="p">,</span> <span class="nx">st</span> <span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">checkCID</span> <span class="o">:=</span> <span class="nx">actor</span><span class="p">.</span><span class="nf">ActorSubstateCID</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">IpldPut</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">()))</span>
    <span class="nx">h</span><span class="p">.</span><span class="nf">Release</span><span class="p">(</span><span class="nx">checkCID</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">h</span> <span class="nx">vmr</span><span class="p">.</span><span class="nx">ActorStateHandle</span><span class="p">,</span> <span class="nx">st</span> <span class="nx">State</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">newCID</span> <span class="o">:=</span> <span class="nx">actor</span><span class="p">.</span><span class="nf">ActorSubstateCID</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">IpldPut</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">()))</span>
    <span class="nx">h</span><span class="p">.</span><span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">newCID</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">st</span> <span class="o">*</span><span class="nx">StorageMinerActorState_I</span><span class="p">)</span> <span class="nf">CID</span><span class="p">()</span> <span class="nx">ipld</span><span class="p">.</span><span class="nx">CID</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>
<span class="kd">func</span> <span class="nf">DeserializeState</span><span class="p">(</span><span class="nx">x</span> <span class="nx">Bytes</span><span class="p">)</span> <span class="nx">State</span> <span class="p">{</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_isChallenged</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">ret</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_isChallenged</span><span class="p">()</span>
    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_challengeHasExpired</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">ret</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_challengeHasExpired</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">())</span>
    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">ret</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1">// Surprise PoSt
</span><span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1"></span>
<span class="c1">// called by StoragePowerActor to notify StorageMiner of PoSt Challenge (triggered by Cron)
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">NotifyOfSurprisePoStChallenge</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nx">rt</span><span class="p">.</span><span class="nf">ValidateImmediateCallerIs</span><span class="p">(</span><span class="nx">addr</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nf">_isChallenged</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span> <span class="c1">// silent return, dont re-challenge
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_expirePreCommittedSectors</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="c1">// update challenge start epoch
</span><span class="c1"></span>    <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">OnNewChallenge</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">())</span>
    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// Called by the cron actor at every tick.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">OnCronTick</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nx">rt</span><span class="p">.</span><span class="nf">ValidateImmediateCallerIs</span><span class="p">(</span><span class="nx">addr</span><span class="p">.</span><span class="nx">CronActorAddr</span><span class="p">)</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_checkSurprisePoStSubmissionHappened</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>

<span class="p">}</span>

<span class="c1">// If the miner fails to respond to a surprise PoSt,
</span><span class="c1">// cron triggers reporting every sector as failing for the current proving period.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_checkSurprisePoStSubmissionHappened</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>

    <span class="c1">// we can return if miner has not yet been challenged
</span><span class="c1"></span>    <span class="k">if</span> <span class="p">!</span><span class="nx">a</span><span class="p">.</span><span class="nf">_isChallenged</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// Miner gets out of a challenge when submit a successful PoSt
</span><span class="c1"></span>        <span class="c1">// or when detected by CronActor. Hence, not being in isChallenged means that we are good here
</span><span class="c1"></span>        <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nf">_challengeHasExpired</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// garbage collection - need to be called by cron once in a while
</span><span class="c1"></span>        <span class="nx">a</span><span class="p">.</span><span class="nf">_expirePreCommittedSectors</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

        <span class="c1">// oh no -- we missed it. rekt
</span><span class="c1"></span>        <span class="nx">a</span><span class="p">.</span><span class="nf">_onMissedSurprisePoSt</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// called by CheckSurprisePoSt above for miner who missed their post
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_onMissedSurprisePoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">failingSectorNumbers</span> <span class="o">:=</span> <span class="nf">getSectorNums</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">())</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">failingSectorNumbers</span> <span class="p">{</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">_updateFailSector</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">_updateExpireSectors</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">newDetectedFaults</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">FailingSectors</span><span class="p">()</span>
    <span class="nx">newTerminatedFaults</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">TerminatedFaults</span><span class="p">()</span>
    <span class="nx">lastPoStResponse</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">LastPoStResponseEpoch</span><span class="p">()</span>

    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_submitPowerReport</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">lastPoStResponse</span><span class="p">)</span>

    <span class="c1">// Note: NewDetectedFaults is now the sum of all
</span><span class="c1"></span>    <span class="c1">// previously active, committed, and recovering sectors minus expired ones
</span><span class="c1"></span>    <span class="c1">// and any previously Failing sectors that did not exceed MaxFaultCount
</span><span class="c1"></span>    <span class="c1">// Note: previously declared faults is now treated as part of detected faults
</span><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nf">_slashCollateralForStorageFaults</span><span class="p">(</span>
        <span class="nx">rt</span><span class="p">,</span>
        <span class="nx">sector</span><span class="p">.</span><span class="nf">CompactSectorSet</span><span class="p">(</span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="c1">// NewDeclaredFaults
</span><span class="c1"></span>        <span class="nx">newDetectedFaults</span><span class="p">,</span>
        <span class="nx">newTerminatedFaults</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1">// end of challenge
</span><span class="c1"></span>    <span class="c1">// now that new power and faults are tracked move pointer of last challenge response up
</span><span class="c1"></span>    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">OnPoStFailure</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">())</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">_processStagedCommittedSectors</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// construct PowerReport from SectorTable
</span><span class="c1">// need lastPoSt to search for new expired deals in _updateSectorUtilization since the lastPost
</span><span class="c1">// where DealExpirationAMT takes in a range of Epoch and return a list of values that expire in that range
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_submitPowerReport</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">lastPoStResponse</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">newExpiredDealIDs</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_updateSectorUtilization</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">lastPoStResponse</span><span class="p">)</span>
    <span class="nx">activePower</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getActivePower</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
    <span class="p">}</span>
    <span class="nx">inactivePower</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getInactivePower</span><span class="p">()</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="nx">err</span><span class="p">.</span><span class="nf">Error</span><span class="p">())</span>
    <span class="p">}</span>

    <span class="c1">// power report in processPowerReportParam
</span><span class="c1"></span>    <span class="nx">_</span> <span class="p">=</span> <span class="o">&amp;</span><span class="nx">spc</span><span class="p">.</span><span class="nx">PowerReport_I</span><span class="p">{</span>
        <span class="nx">ActivePower_</span><span class="p">:</span>   <span class="nx">activePower</span><span class="p">,</span>
        <span class="nx">InactivePower_</span><span class="p">:</span> <span class="nx">inactivePower</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1">// @param powerReport spc.PowerReport
</span><span class="c1"></span>    <span class="nx">processPowerReportParam</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1">// @param dealIDs []deal.DealID
</span><span class="c1"></span>    <span class="nx">processDealExpirationParam</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO: serialize arguments&#34;</span><span class="p">)</span>

    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="c1">// this will go through even if miners do not have the right amount of pledge collateral
</span><span class="c1"></span>    <span class="c1">// when _submitPowerReport is called in DeclareFaults and _onMissedSurprisePoSt for power slashing
</span><span class="c1"></span>    <span class="c1">// however in SubmitSurprisePoSt EnsurePledgeCollateralSatsified will be called
</span><span class="c1"></span>    <span class="c1">// to ensure that miners have the required pledge collateral
</span><span class="c1"></span>    <span class="c1">// otherwise, post submission will fail
</span><span class="c1"></span>    <span class="c1">// Note: there is no power update in RecoverFaults and hence no EnsurePledgeCollatera or _submitPowerReport
</span><span class="c1"></span>    <span class="c1">// Note: ElectionPoSt will always go through and some block rewards will go to LockedBalance in StoragePowerActor
</span><span class="c1"></span>    <span class="c1">// if the block winning miner is undercollateralized
</span><span class="c1"></span>    <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">spc</span><span class="p">.</span><span class="nx">Method_StoragePowerActor_ProcessPowerReport</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">processPowerReportParam</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">newExpiredDealIDs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
            <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StorageMarketActorAddr</span><span class="p">,</span>
            <span class="nx">Method_</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">Method_StorageMarketActor_ProcessDealExpiration</span><span class="p">,</span>
            <span class="nx">Params_</span><span class="p">:</span> <span class="nx">processDealExpirationParam</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_claimDealPayments</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">activeDealIDs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ActiveSectors_</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">utilizationInfo</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_safeGetUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">newActiveDealIDs</span> <span class="o">:=</span> <span class="nx">utilizationInfo</span><span class="p">.</span><span class="nf">DealExpirationAMT</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">ActiveDealIDs</span><span class="p">()</span>
        <span class="nx">activeDealIDs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">activeDealIDs</span><span class="p">,</span> <span class="nx">newActiveDealIDs</span><span class="o">...</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// @params dealIDs []deal.DealID activeDealIDs
</span><span class="c1"></span>    <span class="nx">processDealPaymentParam</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dealID</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">activeDealIDs</span> <span class="p">{</span>
        <span class="nx">processDealPaymentParam</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">processDealPaymentParam</span><span class="p">,</span> <span class="nx">deal</span><span class="p">.</span><span class="nf">Serialize_DealID</span><span class="p">(</span><span class="nx">dealID</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StorageMarketActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">Method_StorageMarketActor_ProcessDealPayment</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">processDealPaymentParam</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// this method is called by both SubmitElectionPoSt and SubmitSurprisePoSt
</span><span class="c1">// - Process ProvingSet.SectorsOn()
</span><span class="c1">//   - State Transitions
</span><span class="c1">//     - Committed -&gt; Active and credit power
</span><span class="c1">//     - Recovering -&gt; Active and credit power
</span><span class="c1">//   - Process Active Sectors (pay miners)
</span><span class="c1">// - Process ProvingSet.SectorsOff()
</span><span class="c1">//     - increment FaultCount
</span><span class="c1">//     - clear Sector and slash pledge collateral if count &gt; MAX_CONSECUTIVE_FAULTS
</span><span class="c1">// - Process Expired Sectors (settle deals and return storage collateral to miners)
</span><span class="c1">//     - State Transition
</span><span class="c1">//       - Failing / Recovering / Active / Committed -&gt; Cleared
</span><span class="c1">//     - Remove SectorNumber from Sectors, ProvingSet
</span><span class="c1">// - Update ChallengeEndEpoch
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_onSuccessfulPoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="c1">// TODO add info on chain
</span><span class="c1"></span>
    <span class="c1">// The proof is verified, process ProvingSet.SectorsOn():
</span><span class="c1"></span>    <span class="c1">// ProvingSet.SectorsOn() contains SectorCommitted, SectorActive, SectorRecovering
</span><span class="c1"></span>    <span class="c1">// ProvingSet itself does not store states, states are all stored in Sectors.State
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sectorState</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
            <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Sector state not found in map&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="nx">sectorState</span><span class="p">.</span><span class="nf">State</span><span class="p">().</span><span class="nx">StateNumber</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">SectorCommittedSN</span><span class="p">,</span> <span class="nx">SectorRecoveringSN</span><span class="p">:</span>
            <span class="nx">st</span><span class="p">.</span><span class="nf">_updateActivateSector</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">)</span>
        <span class="k">case</span> <span class="nx">SectorActiveSN</span><span class="p">:</span>
            <span class="c1">// do nothing, deal payment is made at the end of this method
</span><span class="c1"></span>        <span class="k">default</span><span class="p">:</span>
            <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Invalid sector state in ProvingSet.SectorsOn()&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// committed and recovering sectors are now active
</span><span class="c1"></span>
    <span class="c1">// Process ProvingSet.SectorsOff()
</span><span class="c1"></span>    <span class="c1">// ProvingSet.SectorsOff() contains SectorFailing
</span><span class="c1"></span>    <span class="c1">// SectorRecovering is Proving and hence will not be in SectorsOff()
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">SectorsOff</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sectorState</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
            <span class="k">continue</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="nx">sectorState</span><span class="p">.</span><span class="nf">State</span><span class="p">().</span><span class="nx">StateNumber</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">SectorFailingSN</span><span class="p">:</span>
            <span class="c1">// heavy penalty if Failing for more than or equal to MAX_CONSECUTIVE_FAULTS
</span><span class="c1"></span>            <span class="c1">// otherwise increment FaultCount in Sectors().State
</span><span class="c1"></span>            <span class="nx">st</span><span class="p">.</span><span class="nf">_updateFailSector</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="k">default</span><span class="p">:</span>
            <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Invalid sector state in ProvingSet.SectorsOff&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// Process Expiration.
</span><span class="c1"></span>    <span class="nx">st</span><span class="p">.</span><span class="nf">_updateExpireSectors</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">newTerminatedFaults</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">TerminatedFaults</span><span class="p">()</span>
    <span class="nx">lastPoStResponse</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">LastPoStResponseEpoch</span><span class="p">()</span>
    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_submitPowerReport</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">lastPoStResponse</span><span class="p">)</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_slashCollateralForStorageFaults</span><span class="p">(</span>
        <span class="nx">rt</span><span class="p">,</span>
        <span class="nx">sector</span><span class="p">.</span><span class="nf">CompactSectorSet</span><span class="p">(</span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="c1">// NewDeclaredFaults
</span><span class="c1"></span>        <span class="nx">sector</span><span class="p">.</span><span class="nf">CompactSectorSet</span><span class="p">(</span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="c1">// NewDetectedFaults
</span><span class="c1"></span>        <span class="nx">newTerminatedFaults</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_claimDealPayments</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">OnPoStSuccess</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">())</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">_processStagedCommittedSectors</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>

<span class="p">}</span>

<span class="c1">// called by verifier to update miner state on successful surprise post
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">SubmitVerifiedSurprisePoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nf">TODO</span><span class="p">()</span> <span class="c1">// TODO: validate caller
</span><span class="c1"></span>
    <span class="c1">// Ensure pledge collateral satisfied
</span><span class="c1"></span>    <span class="c1">// otherwise, abort SubmitVerifiedSurprisePoSt
</span><span class="c1"></span>    <span class="nx">a</span><span class="p">.</span><span class="nf">_ensurePledgeCollateralSatisfied</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nf">_onSuccessfulPoSt</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">onChainInfo</span><span class="p">)</span>

<span class="p">}</span>

<span class="c1">// Called by StoragePowerConsensus subsystem after verifying the Election proof
</span><span class="c1">// and verifying the PoSt proof in the block header.
</span><span class="c1">// Assume ElectionPoSt has already been successfully verified when the function gets called.
</span><span class="c1">// Likewise assume that the rewards have already been granted to the storage miner actor. This only handles sector management.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">SubmitVerifiedElectionPoSt</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>

    <span class="c1">// TODO: validate caller
</span><span class="c1"></span>    <span class="c1">// the caller MUST be the miner who won the block (who won the block should be callable as a a VM runtime call)
</span><span class="c1"></span>    <span class="c1">// we also need to enforce that this call happens only once per block, OR make it not callable by special privileged messages
</span><span class="c1"></span>    <span class="nf">TODO</span><span class="p">()</span>

    <span class="c1">// we do not need to verify post submission here, as this should have already been done
</span><span class="c1"></span>    <span class="c1">// outside of the VM, in StoragePowerConsensus Subsystem. Doing so again would waste
</span><span class="c1"></span>    <span class="c1">// significant resources, as proofs are expensive to verify.
</span><span class="c1"></span>    <span class="c1">//
</span><span class="c1"></span>    <span class="c1">// notneeded := a._verifyPoStSubmission(rt)
</span><span class="c1"></span>
    <span class="c1">// the following will update last challenge response time
</span><span class="c1"></span>    <span class="k">return</span> <span class="nx">a</span><span class="p">.</span><span class="nf">_onSuccessfulPoSt</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">onChainInfo</span><span class="p">)</span>

<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1">// Faults
</span><span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1"></span>
<span class="c1">// RecoverFaults checks if miners have sufficent collateral
</span><span class="c1">// and adds SectorFailing into SectorRecovering
</span><span class="c1">// - State Transition
</span><span class="c1">//   - Failing -&gt; Recovering with the same FaultCount
</span><span class="c1">// - Add SectorNumber to ProvingSet
</span><span class="c1">// Note that power is not updated until it is active
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">RecoverFaults</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">recoveringSet</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nf">TODO</span><span class="p">()</span> <span class="c1">// TODO: validate caller
</span><span class="c1"></span>
    <span class="c1">// RecoverFaults is only called when miners are not challenged
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nf">_isChallenged</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;cannot RecoverFaults when sm isChallenged&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="c1">// for all SectorNumber marked as recovering by recoveringSet
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">recoveringSet</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">sectorState</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">!</span><span class="nx">found</span> <span class="p">{</span>
            <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Sector state not found in map&#34;</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="k">switch</span> <span class="nx">sectorState</span><span class="p">.</span><span class="nf">State</span><span class="p">().</span><span class="nx">StateNumber</span> <span class="p">{</span>
        <span class="k">case</span> <span class="nx">SectorFailingSN</span><span class="p">:</span>
            <span class="c1">// pledge collateral is ensured at PoSt submission
</span><span class="c1"></span>            <span class="c1">// no need to top up deal collateral because none was slashed during declared/detected faults
</span><span class="c1"></span>
            <span class="c1">// copy over the same FaultCount
</span><span class="c1"></span>            <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">sectorNo</span><span class="p">].</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">State_</span> <span class="p">=</span> <span class="nf">SectorRecovering</span><span class="p">(</span><span class="nx">sectorState</span><span class="p">.</span><span class="nf">State</span><span class="p">().</span><span class="nx">FaultCount</span><span class="p">)</span>
            <span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>

            <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">FailingSectors_</span><span class="p">.</span><span class="nf">Remove</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>
            <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">RecoveringSectors_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">sectorNo</span><span class="p">)</span>

        <span class="k">default</span><span class="p">:</span>
            <span class="c1">// TODO: determine proper error here and error-handling machinery
</span><span class="c1"></span>            <span class="c1">// TODO: consider this a no-op (as opposed to a failure), because this is a user
</span><span class="c1"></span>            <span class="c1">// call that may be delayed by the chain beyond some other state transition.
</span><span class="c1"></span>            <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Invalid sector state in RecoverFaults&#34;</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// DeclareFaults penalizes miners (slashStorageDealCollateral and remove power)
</span><span class="c1">// - State Transition
</span><span class="c1">//   - Active / Commited / Recovering -&gt; Failing
</span><span class="c1">// - Update State in Sectors()
</span><span class="c1">// - Remove Active / Commited / Recovering from ProvingSet
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">DeclareFaults</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">faultSet</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nf">TODO</span><span class="p">()</span> <span class="c1">// TODO: validate caller
</span><span class="c1"></span>
    <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nf">_isChallenged</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;cannot DeclareFaults when challenged&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="c1">// fail all SectorNumber marked as Failing by faultSet
</span><span class="c1"></span>    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">faultSet</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">_updateFailSector</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">,</span> <span class="kc">false</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">lastPoStResponse</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">LastPoStResponseEpoch</span><span class="p">()</span>

    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_submitPowerReport</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">lastPoStResponse</span><span class="p">)</span>

    <span class="nx">a</span><span class="p">.</span><span class="nf">_slashCollateralForStorageFaults</span><span class="p">(</span>
        <span class="nx">rt</span><span class="p">,</span>
        <span class="nx">faultSet</span><span class="p">,</span>                                 <span class="c1">// NewDeclaredFaults
</span><span class="c1"></span>        <span class="nx">sector</span><span class="p">.</span><span class="nf">CompactSectorSet</span><span class="p">(</span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="c1">// NewDetectedFaults
</span><span class="c1"></span>        <span class="nx">sector</span><span class="p">.</span><span class="nf">CompactSectorSet</span><span class="p">(</span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">)),</span> <span class="c1">// NewTerminatedFault
</span><span class="c1"></span>    <span class="p">)</span>

    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_slashDealsForStorageFault</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNumbers</span> <span class="p">[]</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">,</span> <span class="nx">faultType</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">StorageFaultType</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">dealIDs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sectorNumbers</span> <span class="p">{</span>

        <span class="nx">utilizationInfo</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_safeGetUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">activeDealIDs</span> <span class="o">:=</span> <span class="nx">utilizationInfo</span><span class="p">.</span><span class="nf">DealExpirationAMT</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">ActiveDealIDs</span><span class="p">()</span>
        <span class="nx">dealIDs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">dealIDs</span><span class="p">,</span> <span class="nx">activeDealIDs</span><span class="o">...</span><span class="p">)</span>

    <span class="p">}</span>

    <span class="c1">// @param dealIDs []deal.DealID
</span><span class="c1"></span>    <span class="c1">// @param faultType sector.StorageFaultType
</span><span class="c1"></span>    <span class="nx">processDealSlashParam</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dealID</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">dealIDs</span> <span class="p">{</span>
        <span class="nx">processDealSlashParam</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">processDealSlashParam</span><span class="p">,</span> <span class="nx">deal</span><span class="p">.</span><span class="nf">Serialize_DealID</span><span class="p">(</span><span class="nx">dealID</span><span class="p">))</span>
    <span class="p">}</span>
    <span class="nx">processDealSlashParam</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">processDealSlashParam</span><span class="p">,</span> <span class="nx">sector</span><span class="p">.</span><span class="nf">Serialize_StorageFaultType</span><span class="p">(</span><span class="nx">faultType</span><span class="p">))</span>
    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StorageMarketActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">Method_StorageMarketActor_ProcessDealSlash</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">processDealSlashParam</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_slashPledgeForStorageFault</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">sectorNumbers</span> <span class="p">[]</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">,</span> <span class="nx">faultType</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">StorageFaultType</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">affectedPower</span> <span class="o">:=</span> <span class="nx">block</span><span class="p">.</span><span class="nf">StoragePower</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">sectorNo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">sectorNumbers</span> <span class="p">{</span>

        <span class="nx">utilizationInfo</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_safeGetUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">sectorNo</span><span class="p">)</span>
        <span class="nx">affectedPower</span> <span class="o">+=</span> <span class="nx">utilizationInfo</span><span class="p">.</span><span class="nf">CurrUtilization</span><span class="p">()</span>

    <span class="p">}</span>

    <span class="c1">// @param affectedPower block.StoragePower
</span><span class="c1"></span>    <span class="c1">// @param faultType sector.StorageFaultType
</span><span class="c1"></span>    <span class="nx">slashPledgeParams</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">slashPledgeParams</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">slashPledgeParams</span><span class="p">,</span> <span class="nx">block</span><span class="p">.</span><span class="nf">Serialize_StoragePower</span><span class="p">(</span><span class="nx">affectedPower</span><span class="p">))</span>
    <span class="nx">slashPledgeParams</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">slashPledgeParams</span><span class="p">,</span> <span class="nx">sector</span><span class="p">.</span><span class="nf">Serialize_StorageFaultType</span><span class="p">(</span><span class="nx">faultType</span><span class="p">))</span>

    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">spc</span><span class="p">.</span><span class="nx">Method_StoragePowerActor_SlashPledgeForStorageFault</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">slashPledgeParams</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="c1">// should always happen after _submitPowerReport to have the most up to date utilization info
</span><span class="c1">// reset NewTerminatedFaults
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_slashCollateralForStorageFaults</span><span class="p">(</span>
    <span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span>
    <span class="nx">newDeclaredFaults</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span><span class="p">,</span> <span class="c1">// diff value
</span><span class="c1"></span>    <span class="nx">newDetectedFaults</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span><span class="p">,</span> <span class="c1">// diff value
</span><span class="c1"></span>    <span class="nx">newTerminatedFaults</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">CompactSectorSet</span><span class="p">,</span> <span class="c1">// diff value
</span><span class="c1"></span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// only terminatedFault will result in collateral deal slashing
</span><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">newTerminatedFaults</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">a</span><span class="p">.</span><span class="nf">_slashDealsForStorageFault</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">newTerminatedFaults</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">(),</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">TerminatedFault</span><span class="p">)</span>
        <span class="nx">a</span><span class="p">.</span><span class="nf">_slashPledgeForStorageFault</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">newTerminatedFaults</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">(),</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">TerminatedFault</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">newDetectedFaults</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">a</span><span class="p">.</span><span class="nf">_slashPledgeForStorageFault</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">newDetectedFaults</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">(),</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">DetectedFault</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">newDeclaredFaults</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">a</span><span class="p">.</span><span class="nf">_slashPledgeForStorageFault</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">newDeclaredFaults</span><span class="p">.</span><span class="nf">SectorsOn</span><span class="p">(),</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">DeclaredFault</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// reset terminated faults
</span><span class="c1"></span>    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">TerminatedFaults_</span> <span class="p">=</span> <span class="nx">sector</span><span class="p">.</span><span class="nf">CompactSectorSet</span><span class="p">(</span><span class="nb">make</span><span class="p">([]</span><span class="kt">byte</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1">// Sector Commitment
</span><span class="c1">////////////////////////////////////////////////////////////////////////////////
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_verifySeal</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainSealVerifyInfo</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nx">info</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Info</span><span class="p">()</span>
    <span class="nx">sectorSize</span> <span class="o">:=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">SectorSize</span><span class="p">()</span>

    <span class="c1">// @param sectorSize util.UVarint
</span><span class="c1"></span>    <span class="c1">// @param dealIDs []deal.DealID onChainInfo.DealIDs()
</span><span class="c1"></span>    <span class="nx">getPieceInfoParams</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="nx">getPieceInfoParams</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">getPieceInfoParams</span><span class="p">,</span> <span class="nx">sector</span><span class="p">.</span><span class="nf">Serialize_SectorSize</span><span class="p">(</span><span class="nx">sectorSize</span><span class="p">))</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dealID</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">DealIDs</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">getPieceInfoParams</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">getPieceInfoParams</span><span class="p">,</span> <span class="nx">deal</span><span class="p">.</span><span class="nf">Serialize_DealID</span><span class="p">(</span><span class="nx">dealID</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">getPieceInfosReceipt</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StorageMarketActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">Method_StorageMarketActor_GetPieceInfosForDealIDs</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">getPieceInfoParams</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="nx">getPieceInfosRet</span> <span class="o">:=</span> <span class="nx">getPieceInfosReceipt</span><span class="p">.</span><span class="nf">ReturnValue</span><span class="p">()</span>
    <span class="nx">pieceInfos</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nf">PieceInfosFromBytes</span><span class="p">(</span><span class="nx">getPieceInfosRet</span><span class="p">)</span>

    <span class="c1">// Unless we enforce a minimum padding amount, this totalPieceSize calculation can be removed.
</span><span class="c1"></span>    <span class="c1">// Leaving for now until that decision is entirely finalized.
</span><span class="c1"></span>    <span class="kd">var</span> <span class="nx">totalPieceSize</span> <span class="nx">util</span><span class="p">.</span><span class="nx">UInt</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">pieceInfo</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">pieceInfos</span> <span class="p">{</span>
        <span class="nx">pieceSize</span> <span class="o">:=</span> <span class="p">(</span><span class="o">*</span><span class="nx">pieceInfo</span><span class="p">).</span><span class="nf">Size</span><span class="p">()</span>
        <span class="nx">totalPieceSize</span> <span class="o">+=</span> <span class="nx">pieceSize</span>
    <span class="p">}</span>

    <span class="nx">unsealedCID</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="nx">filproofs</span><span class="p">.</span><span class="nf">ComputeUnsealedSectorCIDFromPieceInfos</span><span class="p">(</span><span class="nx">sectorSize</span><span class="p">,</span> <span class="nx">pieceInfos</span><span class="p">)</span>

    <span class="nx">sealCfg</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SealCfg_I</span><span class="p">{</span>
        <span class="nx">SectorSize_</span><span class="p">:</span>  <span class="nx">sectorSize</span><span class="p">,</span>
        <span class="nx">WindowCount_</span><span class="p">:</span> <span class="nx">info</span><span class="p">.</span><span class="nf">WindowCount</span><span class="p">(),</span>
        <span class="nx">Partitions_</span><span class="p">:</span>  <span class="nx">info</span><span class="p">.</span><span class="nf">SealPartitions</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="c1">// @param address addr.Address info.Worker()
</span><span class="c1"></span>    <span class="nx">getActorIDParams</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="nx">getActorIDParams</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">getActorIDParams</span><span class="p">,</span> <span class="nx">addr</span><span class="p">.</span><span class="nf">Serialize_Address</span><span class="p">(</span><span class="nx">info</span><span class="p">.</span><span class="nf">Worker</span><span class="p">()))</span>

    <span class="nx">getActorIDReceipt</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">InitActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">sys</span><span class="p">.</span><span class="nx">Method_InitActor_GetActorIDForAddress</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">getActorIDParams</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="nx">getActorIDRet</span> <span class="o">:=</span> <span class="nx">getActorIDReceipt</span><span class="p">.</span><span class="nf">ReturnValue</span><span class="p">()</span>
    <span class="nx">minerID</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">addr</span><span class="p">.</span><span class="nf">Deserialize_Address</span><span class="p">(</span><span class="nx">getActorIDRet</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;sm.verifySeal: failed to get actor id&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">svInfo</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SealVerifyInfo_I</span><span class="p">{</span>
        <span class="nx">SectorID_</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorID_I</span><span class="p">{</span>
            <span class="nx">MinerID_</span><span class="p">:</span> <span class="nx">minerID</span><span class="p">,</span>
            <span class="nx">Number_</span><span class="p">:</span>  <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">(),</span>
        <span class="p">},</span>
        <span class="nx">OnChain_</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">,</span>

        <span class="c1">// TODO: Make SealCfg sector.SealCfg from miner configuration (where is that?)
</span><span class="c1"></span>        <span class="nx">SealCfg_</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">sealCfg</span><span class="p">,</span>

        <span class="nx">Randomness_</span><span class="p">:</span>            <span class="nx">sector</span><span class="p">.</span><span class="nf">SealRandomness</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">Randomness</span><span class="p">(</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SealEpoch</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="nx">InteractiveRandomness_</span><span class="p">:</span> <span class="nx">sector</span><span class="p">.</span><span class="nf">InteractiveSealRandomness</span><span class="p">(</span><span class="nx">rt</span><span class="p">.</span><span class="nf">Randomness</span><span class="p">(</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">InteractiveEpoch</span><span class="p">(),</span> <span class="mi">0</span><span class="p">)),</span>
        <span class="nx">UnsealedCID_</span><span class="p">:</span>           <span class="nx">unsealedCID</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nx">sdr</span> <span class="o">:=</span> <span class="nx">filproofs</span><span class="p">.</span><span class="nf">WinSDRParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">filproofs</span><span class="p">.</span><span class="nx">SDRCfg_I</span><span class="p">{</span><span class="nx">SealCfg_</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">sealCfg</span><span class="p">})</span>
    <span class="k">return</span> <span class="nx">sdr</span><span class="p">.</span><span class="nf">VerifySeal</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">svInfo</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// Deals must be posted on chain via sma.PublishStorageDeals before PreCommitSector
</span><span class="c1">// Optimization: PreCommitSector could contain a list of deals that are not published yet.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">PreCommitSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">info</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorPreCommitInfo</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nf">TODO</span><span class="p">()</span> <span class="c1">// TODO: validate caller
</span><span class="c1"></span>    <span class="c1">// can be called regardless of Challenged status
</span><span class="c1"></span>
    <span class="c1">// TODO: might be a good place for Treasury
</span><span class="c1"></span>
    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">msgValue</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">ValueReceived</span><span class="p">()</span>
    <span class="nx">depositReq</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getPreCommitDepositReq</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="k">if</span> <span class="nx">msgValue</span> <span class="p">&lt;</span> <span class="nx">depositReq</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortFundsMsg</span><span class="p">(</span><span class="s">&#34;sm.PreCommitSector: insufficient precommit deposit.&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">_</span><span class="p">,</span> <span class="nx">found</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">PreCommittedSectors</span><span class="p">()[</span><span class="nx">info</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">()]</span>

    <span class="k">if</span> <span class="nx">found</span> <span class="p">{</span>
        <span class="c1">// no burn funds since miners can&#39;t do repeated precommit
</span><span class="c1"></span>        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Sector already pre committed.&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">st</span><span class="p">.</span><span class="nf">_assertSectorDidNotExist</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">())</span>

    <span class="c1">// @param dealIDs []deal.DealID info.DealIDs()
</span><span class="c1"></span>    <span class="nx">params</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dealID</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">info</span><span class="p">.</span><span class="nf">DealIDs</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">params</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">params</span><span class="p">,</span> <span class="nx">deal</span><span class="p">.</span><span class="nf">Serialize_DealID</span><span class="p">(</span><span class="nx">dealID</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nf">Release</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="c1">// verify every DealID has been published and will not expire
</span><span class="c1"></span>    <span class="c1">// before the MAX_PROVE_COMMIT_SECTOR_EPOCH + CurrEpoch
</span><span class="c1"></span>    <span class="c1">// abort otherwise
</span><span class="c1"></span>    <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StorageMarketActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">Method_StorageMarketActor_VerifyPublishedDealIDs</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">params</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">precommittedSector</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">PreCommittedSector_I</span><span class="p">{</span>
        <span class="nx">Info_</span><span class="p">:</span>          <span class="nx">info</span><span class="p">,</span>
        <span class="nx">ReceivedEpoch_</span><span class="p">:</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">(),</span>
    <span class="p">}</span>
    <span class="nx">st</span><span class="p">.</span><span class="nf">PreCommittedSectors</span><span class="p">()[</span><span class="nx">info</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">()]</span> <span class="p">=</span> <span class="nx">precommittedSector</span>

    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">ProveCommitSector</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">,</span> <span class="nx">info</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">SectorProveCommitInfo</span><span class="p">)</span> <span class="nx">InvocOutput</span> <span class="p">{</span>
    <span class="nf">TODO</span><span class="p">()</span> <span class="c1">// TODO: validate caller
</span><span class="c1"></span>
    <span class="nx">msgSender</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">ImmediateCaller</span><span class="p">()</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">preCommitSector</span><span class="p">,</span> <span class="nx">precommitFound</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">PreCommittedSectors</span><span class="p">()[</span><span class="nx">info</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">()]</span>

    <span class="k">if</span> <span class="p">!</span><span class="nx">precommitFound</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Sector not pre committed.&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">st</span><span class="p">.</span><span class="nf">_assertSectorDidNotExist</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">info</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">())</span>

    <span class="c1">// check if ProveCommitSector comes too late after PreCommitSector
</span><span class="c1"></span>    <span class="nx">elapsedEpoch</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">()</span> <span class="o">-</span> <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">ReceivedEpoch</span><span class="p">()</span>

    <span class="c1">// if more than MAX_PROVE_COMMIT_SECTOR_EPOCH has elapsed
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">elapsedEpoch</span> <span class="p">&gt;</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">MAX_PROVE_COMMIT_SECTOR_EPOCH</span> <span class="p">{</span>

        <span class="c1">// PreCommittedSectors is cleaned up at _expirePreCommitSectors triggered by Cron
</span><span class="c1"></span>        <span class="nx">rt</span><span class="p">.</span><span class="nf">Abort</span><span class="p">(</span>
            <span class="nx">exitcode</span><span class="p">.</span><span class="nf">UserDefinedError</span><span class="p">(</span><span class="nx">exitcode</span><span class="p">.</span><span class="nx">DeadlineExceeded</span><span class="p">),</span>
            <span class="s">&#34;more than MAX_PROVE_COMMIT_SECTOR_EPOCH has elapsed&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">onChainInfo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainSealVerifyInfo_I</span><span class="p">{</span>
        <span class="nx">SealedCID_</span><span class="p">:</span>        <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">SealedCID</span><span class="p">(),</span>
        <span class="nx">SealEpoch_</span><span class="p">:</span>        <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">SealEpoch</span><span class="p">(),</span>
        <span class="nx">InteractiveEpoch_</span><span class="p">:</span> <span class="nx">info</span><span class="p">.</span><span class="nf">InteractiveEpoch</span><span class="p">(),</span>
        <span class="nx">Proof_</span><span class="p">:</span>            <span class="nx">info</span><span class="p">.</span><span class="nf">Proof</span><span class="p">(),</span>
        <span class="nx">DealIDs_</span><span class="p">:</span>          <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">DealIDs</span><span class="p">(),</span>
        <span class="nx">SectorNumber_</span><span class="p">:</span>     <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">SectorNumber</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="nx">isSealVerified</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_verifySeal</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">onChainInfo</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">!</span><span class="nx">isSealVerified</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">Abort</span><span class="p">(</span>
            <span class="nx">exitcode</span><span class="p">.</span><span class="nf">UserDefinedError</span><span class="p">(</span><span class="nx">exitcode</span><span class="p">.</span><span class="nx">SealVerificationFailed</span><span class="p">),</span>
            <span class="s">&#34;Seal verification failed&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="nx">_</span><span class="p">,</span> <span class="nx">utilizationFound</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">SectorUtilization</span><span class="p">()[</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">()]</span>
    <span class="k">if</span> <span class="nx">utilizationFound</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;sm.ProveCommitSector: sector number found in SectorUtilization&#34;</span><span class="p">)</span>
    <span class="p">}</span>

    <span class="c1">// Activate storage deals, abort if activation failed
</span><span class="c1"></span>    <span class="c1">// @param dealIDs []deal.DealID onChainInfo.DealIDs()
</span><span class="c1"></span>    <span class="nx">activateDealsParams</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dealID</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">DealIDs</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">activateDealsParams</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">activateDealsParams</span><span class="p">,</span> <span class="nx">deal</span><span class="p">.</span><span class="nf">Serialize_DealID</span><span class="p">(</span><span class="nx">dealID</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="nx">activateDealsReceipt</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StorageMarketActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">Method_StorageMarketActor_ActivateDeals</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">activateDealsParams</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="p">=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">activateDealsRet</span> <span class="o">:=</span> <span class="nx">activateDealsReceipt</span><span class="p">.</span><span class="nf">ReturnValue</span><span class="p">()</span>
    <span class="nx">deals</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">OnChainDeal</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="nx">activateDealsRet</span><span class="p">))</span>
    <span class="nx">onchainDeal</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">deal</span><span class="p">.</span><span class="nf">Deserialize_OnChainDeal</span><span class="p">(</span><span class="nx">activateDealsRet</span><span class="p">)</span>
    <span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">AbortStateMsg</span><span class="p">(</span><span class="s">&#34;Failed to deserialize OnChainDeal&#34;</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="nx">deals</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">deals</span><span class="p">,</span> <span class="nx">onchainDeal</span><span class="p">)</span>
    <span class="nx">initialUtilization</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_initializeUtilizationInfo</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">deals</span><span class="p">)</span>
    <span class="nx">lastDealExpiration</span> <span class="o">:=</span> <span class="nx">initialUtilization</span><span class="p">.</span><span class="nf">DealExpirationAMT</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">LastDealExpiration</span><span class="p">()</span>

    <span class="c1">// add sector expiration to SectorExpirationQueue
</span><span class="c1"></span>    <span class="nx">st</span><span class="p">.</span><span class="nf">SectorExpirationQueue</span><span class="p">().</span><span class="nf">Add</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">SectorExpirationQueueItem_I</span><span class="p">{</span>
        <span class="nx">SectorNumber_</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">(),</span>
        <span class="nx">Expiration_</span><span class="p">:</span>   <span class="nx">lastDealExpiration</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="c1">// no need to store the proof and randomseed in the state tree
</span><span class="c1"></span>    <span class="c1">// verify and drop, only SealCommitment{CommR, DealIDs} on chain
</span><span class="c1"></span>    <span class="nx">sealCommitment</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SealCommitment_I</span><span class="p">{</span>
        <span class="nx">SealedCID_</span><span class="p">:</span>  <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SealedCID</span><span class="p">(),</span>
        <span class="nx">DealIDs_</span><span class="p">:</span>    <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">DealIDs</span><span class="p">(),</span>
        <span class="nx">Expiration_</span><span class="p">:</span> <span class="nx">lastDealExpiration</span><span class="p">,</span> <span class="c1">// TODO decide if we need this too
</span><span class="c1"></span>    <span class="p">}</span>

    <span class="c1">// add SectorNumber and SealCommitment to Sectors
</span><span class="c1"></span>    <span class="c1">// set Sectors.State to SectorCommitted
</span><span class="c1"></span>    <span class="c1">// Note that SectorNumber will only become Active at the next successful PoSt
</span><span class="c1"></span>    <span class="nx">sealOnChainInfo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">SectorOnChainInfo_I</span><span class="p">{</span>
        <span class="nx">SealCommitment_</span><span class="p">:</span> <span class="nx">sealCommitment</span><span class="p">,</span>
        <span class="nx">State_</span><span class="p">:</span>          <span class="nf">SectorCommitted</span><span class="p">(),</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="nx">a</span><span class="p">.</span><span class="nf">_isChallenged</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// move PreCommittedSector to StagedCommittedSectors if in Challenged status
</span><span class="c1"></span>        <span class="nx">stagedSectorInfo</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">StagedCommittedSectorInfo_I</span><span class="p">{</span>
            <span class="nx">Sector_</span><span class="p">:</span>      <span class="nx">sealOnChainInfo</span><span class="p">,</span>
            <span class="nx">Utilization_</span><span class="p">:</span> <span class="nx">initialUtilization</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="nx">st</span><span class="p">.</span><span class="nf">StagedCommittedSectors</span><span class="p">()[</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">()]</span> <span class="p">=</span> <span class="nx">stagedSectorInfo</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// move PreCommittedSector to CommittedSectors if not in Challenged status
</span><span class="c1"></span>        <span class="nx">st</span><span class="p">.</span><span class="nf">Sectors</span><span class="p">()[</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">()]</span> <span class="p">=</span> <span class="nx">sealOnChainInfo</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">ProvingSet_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">())</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorTable</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nx">CommittedSectors_</span><span class="p">.</span><span class="nf">Add</span><span class="p">(</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">())</span>
        <span class="nx">st</span><span class="p">.</span><span class="nf">SectorUtilization</span><span class="p">()[</span><span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">SectorNumber</span><span class="p">()]</span> <span class="p">=</span> <span class="nx">initialUtilization</span>
    <span class="p">}</span>

    <span class="c1">// now remove SectorNumber from PreCommittedSectors (processed)
</span><span class="c1"></span>    <span class="nb">delete</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">PreCommittedSectors</span><span class="p">(),</span> <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">SectorNumber</span><span class="p">())</span>
    <span class="nx">depositReq</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getPreCommitDepositReq</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="c1">// return deposit requirement to sender
</span><span class="c1"></span>    <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>    <span class="nx">msgSender</span><span class="p">,</span>
        <span class="nx">Value_</span><span class="p">:</span> <span class="nx">depositReq</span><span class="p">,</span>
    <span class="p">})</span>

    <span class="k">return</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">SuccessReturn</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_ensurePledgeCollateralSatisfied</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">emptyParams</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
        <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span><span class="p">,</span>
        <span class="nx">Method_</span><span class="p">:</span> <span class="nx">spc</span><span class="p">.</span><span class="nx">Method_StoragePowerActor_EnsurePledgeCollateralSatisfied</span><span class="p">,</span>
        <span class="nx">Params_</span><span class="p">:</span> <span class="nx">emptyParams</span><span class="p">,</span>
    <span class="p">})</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">a</span> <span class="o">*</span><span class="nx">StorageMinerActorCode_I</span><span class="p">)</span> <span class="nf">_expirePreCommittedSectors</span><span class="p">(</span><span class="nx">rt</span> <span class="nx">Runtime</span><span class="p">)</span> <span class="p">{</span>

    <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span> <span class="o">:=</span> <span class="nx">a</span><span class="p">.</span><span class="nf">State</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>

    <span class="nx">expiredSectorNum</span> <span class="o">:=</span> <span class="mi">0</span>
    <span class="nx">inactiveDealIDs</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">deal</span><span class="p">.</span><span class="nx">DealID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">preCommitSector</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">st</span><span class="p">.</span><span class="nf">PreCommittedSectors</span><span class="p">()</span> <span class="p">{</span>

        <span class="nx">elapsedEpoch</span> <span class="o">:=</span> <span class="nx">rt</span><span class="p">.</span><span class="nf">CurrEpoch</span><span class="p">()</span> <span class="o">-</span> <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">ReceivedEpoch</span><span class="p">()</span>

        <span class="k">if</span> <span class="nx">elapsedEpoch</span> <span class="p">&gt;</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">MAX_PROVE_COMMIT_SECTOR_EPOCH</span> <span class="p">{</span>
            <span class="nb">delete</span><span class="p">(</span><span class="nx">st</span><span class="p">.</span><span class="nf">PreCommittedSectors</span><span class="p">(),</span> <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">SectorNumber</span><span class="p">())</span>
            <span class="nx">expiredSectorNum</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="nx">inactiveDealIDs</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">inactiveDealIDs</span><span class="p">,</span> <span class="nx">preCommitSector</span><span class="p">.</span><span class="nf">Info</span><span class="p">().</span><span class="nf">DealIDs</span><span class="p">()</span><span class="o">...</span><span class="p">)</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="nx">depositToBurn</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getPreCommitDepositReq</span><span class="p">(</span><span class="nx">rt</span><span class="p">)</span>
    <span class="nf">UpdateRelease</span><span class="p">(</span><span class="nx">rt</span><span class="p">,</span> <span class="nx">h</span><span class="p">,</span> <span class="nx">st</span><span class="p">)</span>

    <span class="c1">// send funds to BurntFundsActor
</span><span class="c1"></span>    <span class="k">if</span> <span class="nx">depositToBurn</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
            <span class="nx">To_</span><span class="p">:</span>    <span class="nx">addr</span><span class="p">.</span><span class="nx">BurntFundsActorAddr</span><span class="p">,</span>
            <span class="nx">Value_</span><span class="p">:</span> <span class="nx">depositToBurn</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="p">}</span>

    <span class="c1">// clear inactive deals
</span><span class="c1"></span>    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">inactiveDealIDs</span><span class="p">)</span> <span class="p">&gt;</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="c1">// @param []deal.DealID inactiveDealIDs
</span><span class="c1"></span>        <span class="nx">dealsToClearParams</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">dealID</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">inactiveDealIDs</span> <span class="p">{</span>
            <span class="nx">dealsToClearParams</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">dealsToClearParams</span><span class="p">,</span> <span class="nx">deal</span><span class="p">.</span><span class="nf">Serialize_DealID</span><span class="p">(</span><span class="nx">dealID</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="nx">rt</span><span class="p">.</span><span class="nf">SendPropagatingErrors</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">vmr</span><span class="p">.</span><span class="nx">InvocInput_I</span><span class="p">{</span>
            <span class="nx">To_</span><span class="p">:</span>     <span class="nx">addr</span><span class="p">.</span><span class="nx">StorageMarketActorAddr</span><span class="p">,</span>
            <span class="nx">Method_</span><span class="p">:</span> <span class="nx">market</span><span class="p">.</span><span class="nx">Method_StorageMarketActor_ClearInactiveDealIDs</span><span class="p">,</span>
            <span class="nx">Params_</span><span class="p">:</span> <span class="nx">dealsToClearParams</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="nf">getSectorNums</span><span class="p">(</span><span class="nx">m</span> <span class="kd">map</span><span class="p">[</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span><span class="p">]</span><span class="nx">SectorOnChainInfo</span><span class="p">)</span> <span class="p">[]</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">l</span> <span class="p">[]</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorNumber</span>
    <span class="k">for</span> <span class="nx">i</span><span class="p">,</span> <span class="nx">_</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">m</span> <span class="p">{</span>
        <span class="nx">l</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">l</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">l</span>
<span class="p">}</span>
</code></pre></div>






</article>

      

      
    </div>

    
  

  <aside class="book-toc level-6 fixed">
    <nav id="TableOfContents">
<ul>
<li><a href="#storagemineractor-interface"><code>StorageMinerActor</code> interface</a></li>
<li><a href="#storagemineractorstate-implementation"><code>StorageMinerActorState</code> implementation</a></li>
<li><a href="#storagemineractorcode-implementation"><code>StorageMinerActorCode</code> implementation</a></li>
</ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
