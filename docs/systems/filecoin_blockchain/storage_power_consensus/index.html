<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Storage Power Consensus | Filecoin Spec</title>



<link rel="stylesheet" href="../../../../book.min.80d177ba9eeab42f747930aec886ccdf593ccbbd4ea5800f45db583ed39a4aed.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=EB+Garamond" />


<link rel="icon" href="../../../../favicon.png" type="image/x-icon">


<link rel="alternate" type="application/rss+xml" href="../../../../docs/systems/filecoin_blockchain/storage_power_consensus/index.xml" title="Filecoin Spec" />

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/javascript" src="./gumshoe.polyfills.min.js"></script>

<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

  <link rel="stylesheet" href="../../../../css/syntax.css">
<link href="../../../../mermaid/mermaid.css" type="text/css" rel="stylesheet" />
<script src="../../../../mermaid/mermaid.js"></script>
<script src="../../../../spec.js"></script>

</head>

<body>
  <input type="checkbox" class="hidden" id="menu-control" />
  <main class="flex container">

    <aside class="book-menu fixed">
      <nav>
<h2 class="book-brand">
  <a href=""><span>Filecoin Spec</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" placeholder="Search" id="book-search-input" maxlength="64" readonly />
  <div class="book-search-spinner spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>





    
  
  
  

  <style>
  nav ul a[href$="\2f docs\2fsystems\2f filecoin_blockchain\2fstorage_power_consensus\2f "] {
      color: #0b3a53;
  }
  </style>


  <div id="menu-toc">

  <div>
    
    <input id="menu-detail-slider" type="range" onchange="onMenuDetailChange();"
      min="1" value="3" max="5" step="1" />

    <span id="menu-detail-slider-label">3</span>
  </div>

  
  
  <ul class="menu-item-section depth-0">
  
      <li>
      
        











<a href="../../../../#intro" class="menu-item depth-1">
    
    
    <strong>
    
        Introduction
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#intro__arch" class="menu-item depth-2">
    
    
        Architecture Diagrams
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__concepts" class="menu-item depth-2">
    
    
        Key Concepts
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__filecoin_vm" class="menu-item depth-2">
    
    
        Filecoin VM
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__process" class="menu-item depth-2">
    
    
        Process
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#intro__process__about" class="menu-item depth-3">
    
    
        About
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__process__fip" class="menu-item depth-3">
    
    
        FIPs
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__process__contributing" class="menu-item depth-3">
    
    
        Contributing
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__process__related_resources" class="menu-item depth-3">
    
    
        Related Resources
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#intro__process__related_resources__research_portal" class="menu-item depth-4">
    
    
        Research portal
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__process__related_resources__network_tooling" class="menu-item depth-4">
    
    
        Network tooling
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#intro__process__related_resources__testing" class="menu-item depth-4">
    
    
        Testing and implementation compliance
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__changelog" class="menu-item depth-2">
    
    
        Change Log
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__system" class="menu-item depth-2">
    
    
        System Decomposition
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#intro__system__why_systems" class="menu-item depth-3">
    
    
        What are Systems?
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#intro__system__impl_systems" class="menu-item depth-3">
    
    
        Implementing Systems
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#systems" class="menu-item depth-1">
    
    
    <strong>
    
        Systems
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes" class="menu-item depth-2">
    ⚙️
    
        <strong>Filecoin Nodes</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types" class="menu-item depth-3">
    
    
        Node Types
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__node" class="menu-item depth-4">
    
    
        Node Interface
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__node_types" class="menu-item depth-4">
    
    
        Examples
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__verifier_node" class="menu-item depth-4">
    
    
        Chain Verifier Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__client_node" class="menu-item depth-4">
    
    
        Client Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__storage_miner_node" class="menu-item depth-4">
    
    
        Storage Miner Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__retrieval_miner_node" class="menu-item depth-4">
    
    
        Retrieval Miner Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__node_types__relayer_node" class="menu-item depth-4">
    
    
        Relayer Node
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_nodes__repository" class="menu-item depth-3">
    
    
        Repository
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_nodes__repository__config" class="menu-item depth-4">
    
    
        Config
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__repository__key" class="menu-item depth-4">
    
    
        KeyStore &amp; user keys
    
</a>



<ul class="menu-item-section depth-4">

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_nodes__repository__ipldstore" class="menu-item depth-4">
    
    
        IpldStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__repository__usage" class="menu-item depth-4">
    
    
        Usage in Systems
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__network" class="menu-item depth-3">
    
    
        Network Interface
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__clock" class="menu-item depth-3">
    
    
        Clock
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_nodes__key_store" class="menu-item depth-3">
    
    
        Key Store
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files" class="menu-item depth-2">
    📑
    
        <strong>Files &amp; Data</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#systems__filecoin_files__file" class="menu-item depth-3">
    
    
        File
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__file__filestore" class="menu-item depth-4">
    
    
        FileStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__piece" class="menu-item depth-3">
    
    
        Piece
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__piece__piece_store" class="menu-item depth-4">
    
    
        PieceStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_files__data_transfer" class="menu-item depth-3">
    
    
        Data Transfer
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm" class="menu-item depth-2">
    💻
    
        <strong>Virtual Machine</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__actor" class="menu-item depth-3">
    
    
        Actor
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__actor__address" class="menu-item depth-4">
    
    
        Address
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__state_tree" class="menu-item depth-3">
    
    
        State Tree
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__message" class="menu-item depth-3">
    
    
        Message
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__runtime" class="menu-item depth-3">
    
    
        Runtime
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__runtime__exitcode" class="menu-item depth-4">
    
    
        Exit Codes
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__runtime__gascost" class="menu-item depth-4">
    
    
        Gas Costs
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors" class="menu-item depth-3">
    
    
        System Actors
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__init_actor" class="menu-item depth-4">
    
    
        InitActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__cron_actor" class="menu-item depth-4">
    
    
        CronActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__account_actor" class="menu-item depth-4">
    
    
        AccountActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_vm__sysactors__reward_actor" class="menu-item depth-4">
    
    
        RewardActor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_vm__interpreter" class="menu-item depth-3">
    
    
        Interpreter
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain" class="menu-item depth-2">
    📦
    
        <strong>Blockchain</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct" class="menu-item depth-3">
    
    
        Blocks
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__block" class="menu-item depth-4">
    
    
        Block
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__tipset" class="menu-item depth-4">
    
    
        Tipset
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__chain" class="menu-item depth-4">
    
    
        Chain
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__chain_manager" class="menu-item depth-4">
    
    
        Chain Manager
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__struct__block_producer" class="menu-item depth-4">
    
    
        Block Producer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__message_pool" class="menu-item depth-3">
    
    
        Message Pool
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__message_pool__message_syncer" class="menu-item depth-4">
    
    
        Message Syncer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__message_pool__message_storage" class="menu-item depth-4">
    
    
        Message Storage
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_blockchain__chainsync" class="menu-item depth-3">
    
    
        ChainSync
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__storage_power_consensus" class="menu-item depth-3">
    
    
        Storage Power Consensus
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor" class="menu-item depth-4">
    
    
        Storage Power Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_token" class="menu-item depth-2">
    📀
    
        <strong>Token</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_token__wallets" class="menu-item depth-3">
    
    
        Wallet
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_token__payments" class="menu-item depth-3">
    
    
        Payments
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_token__payment_channels" class="menu-item depth-3">
    
    
        Payment Channels
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_token__payment_channels__payment_channel_actor" class="menu-item depth-4">
    
    
        Payment Channel Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_token__multisig" class="menu-item depth-3">
    
    
        Multisig Wallet
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_token__multisig__multisig_actor" class="menu-item depth-4">
    
    
        Multisig Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining" class="menu-item depth-2">
    ⛏
    
        <strong>Storage Mining</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining__storage_mining" class="menu-item depth-3">
    
    
        Storage Miner
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__storage_mining__mining_cycle" class="menu-item depth-4">
    
    
        Storage Mining Cycle
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__storage_mining__storage_miner_actor" class="menu-item depth-4">
    
    
        Storage Miner Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector" class="menu-item depth-3">
    
    
        Sector
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector__sectorset" class="menu-item depth-4">
    
    
        Sector Set
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector__sealing" class="menu-item depth-4">
    
    
        Sector Sealing
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector_index" class="menu-item depth-3">
    
    
        Sector Index
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
    </li>

    <li>
    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector_index__sector_builder" class="menu-item depth-4">
    
    
        Sector Builder
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__sector_index__sector_store" class="menu-item depth-4">
    
    
        SectorStore
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_mining__storage_proving" class="menu-item depth-3">
    
    
        Storage Proving
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining__storage_proving__sealer" class="menu-item depth-4">
    
    
        Sector Sealer
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_mining__storage_proving__poster" class="menu-item depth-4">
    
    
        Sector Poster
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets" class="menu-item depth-2">
    ⚖️
    
        <strong>Market</strong>
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__order" class="menu-item depth-3">
    
    
        Orders
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__deal" class="menu-item depth-3">
    
    
        Deals
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__storage_market" class="menu-item depth-3">
    
    
        Storage Market
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__storage_market_actor" class="menu-item depth-4">
    
    
        Storage Market Actor
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__storage_provider" class="menu-item depth-4">
    
    
        Storage Provider
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__storage_client" class="menu-item depth-4">
    
    
        Storage Client
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__storage_market__faults" class="menu-item depth-4">
    
    
        Faults
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#systems__filecoin_markets__retrieval_market" class="menu-item depth-3">
    
    
        Retrieval Market
    
</a>



<ul class="menu-item-section depth-3">

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_peer_resolver" class="menu-item depth-4">
    
    
        Retrieval Peer Resolver
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_protocols" class="menu-item depth-4">
    
    
        Retrieval Protocols
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_client" class="menu-item depth-4">
    
    
        Retrieval Client
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#systems__filecoin_markets__retrieval_market__retrieval_provider" class="menu-item depth-4">
    
    
        Retrieval Provider (Miner)
    
</a>



<ul class="menu-item-section depth-4">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        










  


<a href="../../../../#libraries" class="menu-item depth-1">
    
    
    <strong>
    
        Libraries
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
    </li>

    <li>
    
      











<a href="../../../../#libraries__fcs" class="menu-item depth-2">
    
    
        FCS
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__ipld" class="menu-item depth-2">
    
    
        IPLD
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#libraries__ipld__cid" class="menu-item depth-3">
    
    
        CID
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#libraries__ipld__datamodel" class="menu-item depth-3">
    
    
        Data Model
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__ipld__selectors" class="menu-item depth-3">
    
    
        Selectors
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__ipld__graphstore" class="menu-item depth-3">
    
    
        GraphStore
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__libp2p" class="menu-item depth-2">
    
    
        libp2p
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      










  


<a href="../../../../#libraries__libp2p__gossipsub" class="menu-item depth-3">
    
    
        gossipsub
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__libp2p__kad_dht" class="menu-item depth-3">
    
    
        kad-dht
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__libp2p__fil_libp2p_nodes" class="menu-item depth-3">
    
    
        fil-libp2p Nodes
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__ipfs" class="menu-item depth-2">
    
    
        IPFS
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#libraries__ipfs__bitswap" class="menu-item depth-3">
    
    
        BitSwap
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#libraries__ipfs__graphsync" class="menu-item depth-3">
    
    
        GraphSync
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#libraries__ipfs__unixfs" class="menu-item depth-3">
    
    
        UnixFS
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      










  


<a href="../../../../#libraries__multiformats" class="menu-item depth-2">
    
    
        Multiformats
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#algorithms" class="menu-item depth-1">
    
    
    <strong>
    
        Algorithms
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#algorithms__expected_consensus" class="menu-item depth-2">
    
    
        Expected Consensus
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__porep" class="menu-item depth-2">
    
    
        Proof-of-Replication
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#algorithms__porep__stacked_drg" class="menu-item depth-3">
    
    
        Stacked DRG PoRep
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__porep__porep_commitments" class="menu-item depth-3">
    
    
        PoRep Commitments
    
</a>




    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__porep__stacked_drg_circuit" class="menu-item depth-3">
    
    
        
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__post" class="menu-item depth-2">
    
    
        Proof-of-Spacetime
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#algorithms__post__election_post" class="menu-item depth-3">
    
    
        Election PoSt
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__post__proof_of_spacetime_parameters" class="menu-item depth-3">
    
    
        PoSt Parameters
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__payment_channels" class="menu-item depth-2">
    
    
        Payment Channels
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__block_sync" class="menu-item depth-2">
    
    
        BlockSync
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__gossip_sub" class="menu-item depth-2">
    
    
        GossipSub
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#algorithms__crypto" class="menu-item depth-2">
    
    
        Cryptographic Primitives
    
</a>




    
    </li>

    <li>
    
      










  


<a href="../../../../#algorithms__cryptoecon" class="menu-item depth-2">
    
    
        Cryptoecon
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#listings" class="menu-item depth-1">
    
    
    <strong>
    
        Listings
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#listings__actors" class="menu-item depth-2">
    
    
        Filecoin VM Actors
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#listings__data_structures" class="menu-item depth-2">
    
    
        Data Structures
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#listings__system_map" class="menu-item depth-2">
    
    
        Components
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#listings__libp2p_protocols" class="menu-item depth-2">
    
    
        libp2p Protocols
    
</a>



<ul class="menu-item-section depth-2">

    <li>
    
      











<a href="../../../../#listings__libp2p_protocols__data_transfer_protocol" class="menu-item depth-3">
    
    
        Data Transfer Protocol
    
</a>



<ul class="menu-item-section depth-3">

</ul>


    
    </li>

</ul>


    
    </li>

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#glossary" class="menu-item depth-1">
    
    
    <strong>
    
        Glossary
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

</ul>


      
      </li>
  
      <li>
      
        











<a href="../../../../#appendix" class="menu-item depth-1">
    
    
    <strong>
    
        Appendix
    
    </strong>
    
</a>



<ul class="menu-item-section depth-1">

    <li>
    
      











<a href="../../../../#appendix__sharray" class="menu-item depth-2">
    
    
        Sharded IPLD Array
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#appendix__address" class="menu-item depth-2">
    
    
        Address
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

    <li>
    
      











<a href="../../../../#appendix__orient" class="menu-item depth-2">
    
    
        Filecoin Parameters
    
</a>



<ul class="menu-item-section depth-2">

</ul>


    
    </li>

</ul>


      
      </li>
  
  </ul>
  
</div>










</nav>


<script>
(function() {
  var menu = document.querySelector("aside.book-menu nav");
  addEventListener("beforeunload", function(event) {
    localStorage.setItem("menu.scrollTop", menu.scrollTop);
  });
  menu.scrollTop = localStorage.getItem("menu.scrollTop");
})();
</script>

    </aside>

    <div class="book-page">
      <header class="flex align-center justify-between book-header">
  <label for="menu-control">
    <img src="../../../../svg/menu.svg" alt="Menu" />
  </label>
  <strong>Storage Power Consensus</strong>
</header>

      
<article class="markdown">

<p><div id="systems__filecoin_blockchain__storage_power_consensus__storage_power_consensus"></div>
The Storage Power Consensus subsystem is the main interface which enables Filecoin nodes to agree on the state of the system. SPC accounts for individual storage miners&rsquo; effective power over consensus in given chains in its <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor__power_table">Power Table</a>. It also runs <a href="../../../../#algorithms__expected_consensus___index">Expected Consensus</a> (the underlying consensus algorithm in use by Filecoin), enabling storage miners to run leader election and generate new blocks updating the state of the Filecoin system.</p>

<p>Succinctly, the SPC subsystem offers the following services:
- Access to the <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor__power_table">Power Table</a> for every subchain, accounting for individual storage miner power and total power on-chain.
- Access to <a href="../../../../#algorithms__expected_consensus___index">Expected Consensus</a> for individual storage miners, enabling:
    - Access to verifiable randomness <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__tickets">Tickets</a> as needed in the rest of the protocol.
    - Running  <a href="../../../../#algorithms__expected_consensus__leader_election">Secret Leader Election</a> to produce new blocks.
    - Running <a href="../../../../#algorithms__expected_consensus__chain_selection">Chain Selection</a> across subchains using EC&rsquo;s weighting function.
    - Identification of <a href="../../../../#algorithms__expected_consensus__finality">the most recently finalized tipset</a>, for use by all protocol participants.</p>

<p>Much of the Storage Power Consensus&rsquo; subsystem functionality is detailed in the code below but we touch upon some of its behaviors in more detail.</p>




















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor/address&#34;</span>
<span class="kn">import</span> <span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
<span class="kn">import</span> <span class="nx">chain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/chain&#34;</span>
<span class="kn">import</span> <span class="nx">st</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
<span class="kn">import</span> <span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
<span class="kn">import</span> <span class="nx">sector</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
<span class="kn">import</span> <span class="nx">blockchain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain&#34;</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusSubsystem</span> <span class="kd">struct</span> <span class="p">{</span><span class="c1">//(@mutable)
</span><span class="c1"></span>    <span class="nf">ChooseTipsetToMine</span><span class="p">(</span><span class="nx">tipsets</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">])</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">]</span>

    <span class="nx">ec</span>          <span class="nx">ExpectedConsensus</span>
    <span class="nx">blockchain</span>  <span class="nx">blockchain</span><span class="p">.</span><span class="nx">BlockchainSubsystem</span>

    <span class="c1">// call by BlockchainSubsystem during block reception
</span><span class="c1"></span>    <span class="nf">ValidateBlock</span><span class="p">(</span><span class="nx">block</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="kt">error</span>

    <span class="nf">IsWinningPartialTicket</span><span class="p">(</span>
        <span class="nx">st</span>                 <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span>
        <span class="nx">partialTicket</span>      <span class="nx">sector</span><span class="p">.</span><span class="nx">PartialTicket</span>
        <span class="nx">sectorUtilization</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">StoragePowerActorState</span>

    <span class="nf">validateTicket</span><span class="p">(</span>
        <span class="nx">tix</span>             <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span>
        <span class="nx">pk</span>              <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFPublicKey</span>
        <span class="nx">minerActorAddr</span>  <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">computeChainWeight</span><span class="p">(</span><span class="nx">tipset</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainWeight</span>

    <span class="nf">StoragePowerConsensusError</span><span class="p">()</span> <span class="nx">StoragePowerConsensusError</span>

    <span class="c1">// Randomness methods
</span><span class="c1"></span>
    <span class="c1">// call by StorageMiningSubsystem during block production
</span><span class="c1"></span>    <span class="nf">GetTicketProductionRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span>

    <span class="c1">// call by StorageMiningSubsystem in sealing sector
</span><span class="c1"></span>    <span class="nf">GetSealRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span>

    <span class="c1">// call by StorageMiningSubsystem after sealing
</span><span class="c1"></span>    <span class="nf">GetPoStChallengeRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span>

    <span class="nf">GetFinality</span><span class="p">()</span>     <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
    <span class="nf">FinalizedEpoch</span><span class="p">()</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusError</span> <span class="kd">struct</span> <span class="p">{}</span>
</code></pre></div>






<h2 id="distinguishing-between-storage-miners-and-block-miners">Distinguishing between storage miners and block miners</h2>

<p>There are two ways to earn Filecoin tokens in the Filecoin network:
- By participating in the <a href="../../../../#systems__filecoin_markets__storage_market___index">Storage Market</a> as a storage provider and being paid by clients for file storage deals.
- By mining new blocks on the network, helping modify system state and secure the Filecoin consensus mechanism.</p>

<p>We must distinguish between both types of &ldquo;miners&rdquo; (storage and block miners). <a href="../../../../#algorithms__expected_consensus__leader_election">Secret Leader Election</a> in Filecoin is predicated on a miner&rsquo;s storage power. Thus, while all block miners will be storage miners, the reverse is not necessarily true.</p>

<p>However, given Filecoin&rsquo;s &ldquo;useful Proof-of-Work&rdquo; is achieved through file storage (PoRep and PoSt), there is little overhead cost for storage miners to participate in leader election. Such a <a href="../../../../#systems__filecoin_mining__storage_mining__storage_miner_actor">Storage Miner Actor</a> need only register with the <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__storage_power_actor">Storage Power Actor</a> in order to participate in Expected Consensus and mine blocks.</p>

<div id="systems__filecoin_blockchain__storage_power_consensus__storage_power"></div>

<h2 id="on-power">On Power</h2>

<p>Per the above, we also clearly distinguish putting storage on-chain from gaining power in consensus (sometimes called &ldquo;Storage Power&rdquo;) as follows:</p>

<p><strong>Consensus power in Filecoin is determined by in-deal storage</strong>. For instance, if a miner had a 32GB sector, 20 of which were used as part of storage deals, only those 20 would contribute to said miner&rsquo;s <em>Storage Power</em>.</p>

<p>Thereafter, power can be either <em>active</em> or <em>inactive</em> as defined in <a href="../../../../#systems__filecoin_mining__storage_mining">Storage Miner</a>.</p>

<div id="systems__filecoin_blockchain__storage_power_consensus__tickets"></div>

<h2 id="tickets">Tickets</h2>

<p>Tickets are used across the Filecoin protocol as sources of randomness:
- The <a href="../../../../#systems__filecoin_mining__storage_proving__sector_sealer">Sector Sealer</a> uses tickets as SealSeeds to bind sector commitments to a given subchain.
- The <a href="../../../../#systems__filecoin_mining__storage_mining">Storage Miner</a> likewise uses tickets as PoStChallenges to prove sectors remain committed as of a given block.
- They are drawn by the Storage Power subsystem as randomness in <a href="../../../../#algorithms__expected_consensus__leader_election">Secret Leader Election</a> to determine their eligibility to mine a block
- They are drawn by the Storage Power subsystem in order to generate new tickets for future use.</p>

<p>Each of these ticket uses may require drawing tickets at different chain epochs, according to the security requirements of the particular protocol making use of tickets. Specifically, the ticket output (which is a SHA256 output) is used for randomness.</p>

<p>In Filecoin, every block header contains a single ticket.</p>

<p>You can find the Ticket data structure <a href="../../../../#listings__data_structures">here</a>.</p>

<h3 id="comparing-tickets-in-a-tipset">Comparing Tickets in a Tipset</h3>

<p>Whenever comparing tickets is evoked in Filecoin, for instance when discussing selecting the &ldquo;min ticket&rdquo; in a Tipset, the comparison is that of the little endian representation of the ticket&rsquo;s VFOutput bytes.</p>

<div id="systems__filecoin_blockchain__storage_power_consensus__ticket_chain"></div>

<h2 id="the-ticket-chain-and-drawing-randomness">The Ticket chain and drawing randomness</h2>

<p>While each Filecoin block header contains a ticket field (see <a href="../../../../#systems__filecoin_blockchain__storage_power_consensus__tickets">Tickets</a>), it is useful to think of a ticket chain abstraction.
Due to the nature of Filecoin&rsquo;s Tipsets and the possibility of using tickets from epochs that did not yield leaders to produce randomness at a given epoch, tracking the canonical ticket of a subchain at a given height can be arduous to reason about in terms of blocks. To that end, it is helpful to create a ticket chain abstraction made up of only those tickets to be used for randomness generation at a given height.</p>

<p>To read more about specifically how tickets are processed for randomness, see <a href="../../../../#algorithms__crypto__randomness">Randomness</a>.</p>

<p>To sample a ticket for a given epoch n:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">Set referenceTipsetOffset = 0
While true:
    Set referenceTipsetHeight = n - referenceTipsetOffset
    If blocks were mined at referenceTipsetHeight:
        ReferenceTipset = TipsetAtHeight(referenceTipsetHeight)
        Select the block in ReferenceTipset with the smallest final ticket, return its value (pastTicket).
    If no blocks were mined at referenceTipsetHeight:
        Increment referenceTipsetOffset
        (Repeat)
newRandomness = H(TicketDrawDST || index || Serialization(epoch || pastTicketOutput))</code></pre></div>
<p>In english, this means two things:
- Choose the smallest ticket in the Tipset if it contains multiple blocks.
- When sampling a ticket from an epoch with no blocks, draw the min ticket from the prior epoch with blocks and concatenate it with
    - the wanted epoch number
    - hash this concatenation for a usable ticket value</p>

<p>See the <code>RandomnessAtEpoch</code> method below:



















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">chain</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
	<span class="s">&#34;github.com/filecoin-project/specs/util&#34;</span>
<span class="p">)</span>

<span class="c1">// Returns the tipset at or immediately prior to `epoch`.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">chain</span> <span class="o">*</span><span class="nx">Chain_I</span><span class="p">)</span> <span class="nf">TipsetAtEpoch</span><span class="p">(</span><span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">Tipset</span> <span class="p">{</span>
	<span class="nx">current</span> <span class="o">:=</span> <span class="nx">chain</span><span class="p">.</span><span class="nf">HeadTipset</span><span class="p">()</span>
	<span class="k">for</span> <span class="nx">current</span><span class="p">.</span><span class="nf">Epoch</span><span class="p">()</span> <span class="p">&gt;</span> <span class="nx">epoch</span> <span class="p">{</span>
		<span class="nx">current</span> <span class="p">=</span> <span class="nx">current</span><span class="p">.</span><span class="nf">Parents</span><span class="p">()</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">current</span>
<span class="p">}</span>

<span class="c1">// Draws randomness from the tipset at or immediately prior to `epoch`.
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">chain</span> <span class="o">*</span><span class="nx">Chain_I</span><span class="p">)</span> <span class="nf">RandomnessAtEpoch</span><span class="p">(</span><span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Bytes</span> <span class="p">{</span>
	<span class="nx">ts</span> <span class="o">:=</span> <span class="nx">chain</span><span class="p">.</span><span class="nf">TipsetAtEpoch</span><span class="p">(</span><span class="nx">epoch</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">ts</span><span class="p">.</span><span class="nf">MinTicket</span><span class="p">().</span><span class="nf">DrawRandomness</span><span class="p">(</span><span class="nx">epoch</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>




</p>

<p>The above means that ticket randomness is reseeded with every new block, but can indeed be derived by any miner for an arbitrary epoch number using a past epoch.</p>

<div id="systems__filecoin_blockchain__storage_power_consensus__ticket_generation"></div>

<h3 id="randomness-ticket-generation">Randomness Ticket generation</h3>

<p>This section discusses how tickets are generated by EC for the <code>Ticket</code> field in every block header.</p>

<p>At round <code>N</code>, a new ticket is generated using tickets drawn from the Tipset at round <code>N-1</code> (as shown below).</p>

<p>The miner runs the prior ticket through a Verifiable Random Function (VRF) to get a new unique ticket which can later be derived for randomness (as shown above). The prior ticket is prepended with the ticket domain separation tag and concatenated with the miner actor address (to ensure miners using the same worker keys get different randomness).</p>

<p>To generate a ticket for a given epoch n:</p>
<div class="highlight"><pre class="chroma"><code class="language-text" data-lang="text">LastTicket = MinTicketValueAtEpoch(n-1)
newRandomness = VRF_miner(H(TicketProdDST || index || Serialization(pastTicket, minerActorAddress)))</code></pre></div>
<p>The VRF&rsquo;s deterministic output adds entropy to the ticket chain, limiting a miner&rsquo;s ability to alter one block to influence a future ticket (given a miner does not know who will win a given round in advance).</p>

<p>We use the VRF from <a href="../../../../#algorithms__crypto__vrf">Verifiable Random Function</a> for ticket generation in EC (see the <code>PrepareNewTicket</code> method below).</p>




















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">storage_mining</span>

<span class="c1">// import sectoridx &#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector_index&#34;
</span><span class="c1">// import actor &#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor&#34;
</span><span class="c1"></span><span class="kn">import</span> <span class="p">(</span>
	<span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
	<span class="nx">filproofs</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/filcrypto/filproofs&#34;</span>
	<span class="nx">ipld</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/ipld&#34;</span>
	<span class="nx">libp2p</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/libp2p&#34;</span>
	<span class="nx">spc</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/storage_power_consensus&#34;</span>
	<span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
	<span class="nx">deal</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_markets/deal&#34;</span>
	<span class="nx">sector</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
	<span class="nx">node_base</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_nodes/node_base&#34;</span>
	<span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor/address&#34;</span>
	<span class="nx">stateTree</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
	<span class="nx">util</span> <span class="s">&#34;github.com/filecoin-project/specs/util&#34;</span>
<span class="p">)</span>

<span class="kd">type</span> <span class="nx">Serialization</span> <span class="p">=</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">CreateMiner</span><span class="p">(</span>
	<span class="nx">ownerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span>
	<span class="nx">workerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">,</span>
	<span class="nx">sectorSize</span> <span class="nx">util</span><span class="p">.</span><span class="nx">UInt</span><span class="p">,</span>
	<span class="nx">peerId</span> <span class="nx">libp2p</span><span class="p">.</span><span class="nx">PeerID</span><span class="p">,</span>
<span class="p">)</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span> <span class="p">{</span>
	<span class="c1">// ownerAddr := sms.generateOwnerAddress(workerPubKey)
</span><span class="c1"></span>	<span class="c1">// var pledgeAmt actor.TokenAmount TODO: unclear how to pass the amount/pay
</span><span class="c1"></span>	<span class="c1">// TODO compute PledgeCollateral for 0 bytes
</span><span class="c1"></span>	<span class="c1">// return sms.StoragePowerActor().CreateStorageMiner(ownerAddr, workerPubKey, sectorSize, peerId)
</span><span class="c1"></span>	<span class="c1">// TODO: access this from runtime
</span><span class="c1"></span>	<span class="c1">// return sms.StoragePowerActor().CreateStorageMiner(ownerAddr, workerAddr, peerId)
</span><span class="c1"></span>	<span class="kd">var</span> <span class="nx">minerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span>
	<span class="k">return</span> <span class="nx">minerAddr</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">HandleStorageDeal</span><span class="p">(</span><span class="nx">deal</span> <span class="nx">deal</span><span class="p">.</span><span class="nx">StorageDeal</span><span class="p">)</span> <span class="p">{</span>
	<span class="nx">sms</span><span class="p">.</span><span class="nf">SectorIndex</span><span class="p">().</span><span class="nf">AddNewDeal</span><span class="p">(</span><span class="nx">deal</span><span class="p">)</span>
	<span class="c1">// stagedDealResponse := sms.SectorIndex().AddNewDeal(deal)
</span><span class="c1"></span>	<span class="c1">// TODO: way within a node to notify different components
</span><span class="c1"></span>	<span class="c1">// markeet.StorageProvider().NotifyStorageDealStaged(&amp;storage_provider.StorageDealStagedNotification_I{
</span><span class="c1"></span>	<span class="c1">// 	Deal_:     deal,
</span><span class="c1"></span>	<span class="c1">// 	SectorID_: stagedDealResponse.SectorID(),
</span><span class="c1"></span>	<span class="c1">// })
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_generateOwnerAddress</span><span class="p">(</span><span class="nx">workerPubKey</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">PublicKey</span><span class="p">)</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">CommitSectorError</span><span class="p">()</span> <span class="nx">deal</span><span class="p">.</span><span class="nx">StorageDeal</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// triggered by new block reception and tipset assembly
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">OnNewBestChain</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">sms</span><span class="p">.</span><span class="nf">_tryLeaderElection</span><span class="p">()</span>
<span class="p">}</span>

<span class="c1">// triggered by wall clock
</span><span class="c1"></span><span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">OnNewRound</span><span class="p">()</span> <span class="p">{</span>
	<span class="nx">sms</span><span class="p">.</span><span class="nf">_tryLeaderElection</span><span class="p">()</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_tryLeaderElection</span><span class="p">()</span> <span class="p">{</span>

	<span class="c1">// Randomness for ElectionPoSt
</span><span class="c1"></span>	<span class="nx">randomnessK</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">GetPoStChallengeRand</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">(),</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">LatestEpoch</span><span class="p">())</span>

	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_preparePoStChallengeSeed</span><span class="p">(</span><span class="nx">randomnessK</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_keyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>
	<span class="nx">postRandomness</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_keyStore</span><span class="p">().</span><span class="nf">WorkerKey</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">Generate</span><span class="p">(</span><span class="nx">input</span><span class="p">).</span><span class="nf">Output</span><span class="p">()</span>

	<span class="c1">// TODO: add how sectors are actually stored in the SMS proving set
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
	<span class="nx">provingSet</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">sector</span><span class="p">.</span><span class="nx">SectorID</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

	<span class="nx">candidates</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">StorageProving</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">GenerateElectionPoStCandidates</span><span class="p">(</span><span class="nx">postRandomness</span><span class="p">,</span> <span class="nx">provingSet</span><span class="p">)</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">candidates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span> <span class="c1">// fail to generate post candidates
</span><span class="c1"></span>	<span class="p">}</span>

	<span class="c1">// TODO Fix
</span><span class="c1"></span>	<span class="nx">util</span><span class="p">.</span><span class="nf">TODO</span><span class="p">()</span>
	<span class="kd">var</span> <span class="nx">currState</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span>
	<span class="nx">winningCandidates</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">([]</span><span class="nx">sector</span><span class="p">.</span><span class="nx">PoStCandidate</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
	<span class="nx">st</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">currState</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_keyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">candidate</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">candidates</span> <span class="p">{</span>
		<span class="nx">sectorNum</span> <span class="o">:=</span> <span class="nx">candidate</span><span class="p">.</span><span class="nf">SectorID</span><span class="p">().</span><span class="nf">Number</span><span class="p">()</span>
		<span class="nx">utilInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getUtilizationInfo</span><span class="p">(</span><span class="nx">sectorNum</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// panic(err)
</span><span class="c1"></span>			<span class="k">return</span>
		<span class="p">}</span>
		<span class="nx">sectorPower</span> <span class="o">:=</span> <span class="nx">utilInfo</span><span class="p">.</span><span class="nf">CurrUtilization</span><span class="p">()</span>
		<span class="k">if</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">IsWinningPartialTicket</span><span class="p">(</span><span class="nx">currState</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">.</span><span class="nf">PartialTicket</span><span class="p">(),</span> <span class="nx">sectorPower</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">winningCandidates</span> <span class="p">=</span> <span class="nb">append</span><span class="p">(</span><span class="nx">winningCandidates</span><span class="p">,</span> <span class="nx">candidate</span><span class="p">)</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nx">winningCandidates</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">{</span>
		<span class="k">return</span>
	<span class="p">}</span>

	<span class="c1">// Randomness for ticket generation in block production
</span><span class="c1"></span>	<span class="nx">randomness1</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">GetTicketProductionRand</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">(),</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">LatestEpoch</span><span class="p">())</span>
	<span class="nx">newTicket</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">PrepareNewTicket</span><span class="p">(</span><span class="nx">randomness1</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_keyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>

	<span class="nx">postProof</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">StorageProving</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">GenerateElectionPoStProof</span><span class="p">(</span><span class="nx">postRandomness</span><span class="p">,</span> <span class="nx">winningCandidates</span><span class="p">)</span>
	<span class="nx">chainHead</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">().</span><span class="nf">HeadTipset</span><span class="p">()</span>

	<span class="nx">sms</span><span class="p">.</span><span class="nf">_blockProducer</span><span class="p">().</span><span class="nf">GenerateBlock</span><span class="p">(</span><span class="nx">postProof</span><span class="p">,</span> <span class="nx">winningCandidates</span><span class="p">,</span> <span class="nx">newTicket</span><span class="p">,</span> <span class="nx">chainHead</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_keyStore</span><span class="p">().</span><span class="nf">MinerAddress</span><span class="p">())</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_preparePoStChallengeSeed</span><span class="p">(</span><span class="nx">randomness</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span><span class="p">,</span> <span class="nx">minerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span> <span class="p">{</span>

	<span class="nx">randInput</span> <span class="o">:=</span> <span class="nf">Serialize_PoStChallengeSeedInput</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">PoStChallengeSeedInput_I</span><span class="p">{</span>
		<span class="nx">ticket_</span><span class="p">:</span>    <span class="nx">randomness</span><span class="p">,</span>
		<span class="nx">minerAddr_</span><span class="p">:</span> <span class="nx">minerAddr</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">DomainSeparationTag_PoSt</span><span class="p">.</span><span class="nf">DeriveRand</span><span class="p">(</span><span class="nx">randInput</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">input</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">PrepareNewTicket</span><span class="p">(</span><span class="nx">randomness</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span><span class="p">,</span> <span class="nx">minerActorAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span> <span class="p">{</span>
	<span class="c1">// run it through the VRF and get deterministic output
</span><span class="c1"></span>
	<span class="c1">// take the VRFResult of that ticket as input, specifying the personalization (see data structures)
</span><span class="c1"></span>	<span class="c1">// append the miner actor address for the miner generifying this in order to prevent miners with the same
</span><span class="c1"></span>	<span class="c1">// worker keys from generating the same randomness (given the VRF)
</span><span class="c1"></span>	<span class="nx">randInput</span> <span class="o">:=</span> <span class="nx">block</span><span class="p">.</span><span class="nf">Serialize_TicketProductionSeedInput</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">block</span><span class="p">.</span><span class="nx">TicketProductionSeedInput_I</span><span class="p">{</span>
		<span class="nx">PastTicket_</span><span class="p">:</span> <span class="nx">randomness</span><span class="p">,</span>
		<span class="nx">MinerAddr_</span><span class="p">:</span>  <span class="nx">minerActorAddr</span><span class="p">,</span>
	<span class="p">})</span>
	<span class="nx">input</span> <span class="o">:=</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">DomainSeparationTag_TicketProduction</span><span class="p">.</span><span class="nf">DeriveRand</span><span class="p">(</span><span class="nx">randInput</span><span class="p">)</span>

	<span class="c1">// run through VRF
</span><span class="c1"></span>	<span class="nx">vrfRes</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_keyStore</span><span class="p">().</span><span class="nf">WorkerKey</span><span class="p">().</span><span class="nf">Impl</span><span class="p">().</span><span class="nf">Generate</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span>

	<span class="nx">newTicket</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">block</span><span class="p">.</span><span class="nx">Ticket_I</span><span class="p">{</span>
		<span class="nx">VRFResult_</span><span class="p">:</span> <span class="nx">vrfRes</span><span class="p">,</span>
		<span class="nx">Output_</span><span class="p">:</span>    <span class="nx">vrfRes</span><span class="p">.</span><span class="nf">Output</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nx">newTicket</span>
<span class="p">}</span>

<span class="c1">// TODO: fix linking here
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">node</span> <span class="nx">node_base</span><span class="p">.</span><span class="nx">FilecoinNode</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">minerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="nx">StorageMinerActorState</span> <span class="p">{</span>
	<span class="nx">actorState</span> <span class="o">:=</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nf">GetActorState</span><span class="p">(</span><span class="nx">minerAddr</span><span class="p">)</span>
	<span class="nx">substateCID</span> <span class="o">:=</span> <span class="nx">actorState</span><span class="p">.</span><span class="nf">State</span><span class="p">()</span>

	<span class="nx">substate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">node</span><span class="p">.</span><span class="nf">LocalGraph</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ipld</span><span class="p">.</span><span class="nf">CID</span><span class="p">(</span><span class="nx">substateCID</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="c1">// TODO fix conversion to bytes
</span><span class="c1"></span>	<span class="nb">panic</span><span class="p">(</span><span class="nx">substate</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">serializedSubstate</span> <span class="nx">Serialization</span>
	<span class="nx">st</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Deserialize_StorageMinerActorState</span><span class="p">(</span><span class="nx">serializedSubstate</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;Deserialization error&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">st</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">spc</span><span class="p">.</span><span class="nx">StoragePowerActorState</span> <span class="p">{</span>
	<span class="nx">powerAddr</span> <span class="o">:=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span>
	<span class="nx">actorState</span> <span class="o">:=</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nf">GetActorState</span><span class="p">(</span><span class="nx">powerAddr</span><span class="p">)</span>
	<span class="nx">substateCID</span> <span class="o">:=</span> <span class="nx">actorState</span><span class="p">.</span><span class="nf">State</span><span class="p">()</span>

	<span class="nx">substate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">node</span><span class="p">.</span><span class="nf">LocalGraph</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ipld</span><span class="p">.</span><span class="nf">CID</span><span class="p">(</span><span class="nx">substateCID</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// TODO fix conversion to bytes
</span><span class="c1"></span>	<span class="nb">panic</span><span class="p">(</span><span class="nx">substate</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">serializedSubstate</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span>
	<span class="nx">st</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">Deserialize_StoragePowerActorState</span><span class="p">(</span><span class="nx">serializedSubstate</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;Deserialization error&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">st</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">GetWorkerKeyByMinerAddress</span><span class="p">(</span><span class="nx">minerAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFPublicKey</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">VerifyElectionPoSt</span><span class="p">(</span><span class="nx">header</span> <span class="nx">block</span><span class="p">.</span><span class="nx">BlockHeader</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>

	<span class="nx">sma</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">(),</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">())</span>
	<span class="nx">spa</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">())</span>

	<span class="c1">// 1. Check that the miner in question is currently allowed to run election
</span><span class="c1"></span>	<span class="c1">// Note that this is two checks, namely:
</span><span class="c1"></span>	<span class="c1">// On SMA --&gt; can the miner be elected per electionPoSt rules?
</span><span class="c1"></span>	<span class="c1">// On SPA --&gt; Does the miner&#39;s power meet the consensus minimum requirement?
</span><span class="c1"></span>	<span class="c1">// we could bundle into a single call here for convenience
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">sma</span><span class="p">.</span><span class="nf">_canBeElected</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">Epoch</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="nx">pow</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">sma</span><span class="p">.</span><span class="nf">_getActivePower</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="c1">// TODO: better error handling
</span><span class="c1"></span>		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">spa</span><span class="p">.</span><span class="nf">ActivePowerMeetsConsensusMinimum</span><span class="p">(</span><span class="nx">pow</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// 2. Verify appropriate randomness
</span><span class="c1"></span>	<span class="c1">// TODO: fix away from BestChain()... every block should track its own chain up to its own production.
</span><span class="c1"></span>	<span class="nx">randomness</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">GetPoStChallengeRand</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">(),</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Epoch</span><span class="p">())</span>
	<span class="nx">postRandomnessInput</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nf">PoStRandomness</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_preparePoStChallengeSeed</span><span class="p">(</span><span class="nx">randomness</span><span class="p">,</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">()))</span>

	<span class="nx">postRand</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFResult_I</span><span class="p">{</span>
		<span class="nx">Output_</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">Randomness</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">postRand</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">postRandomnessInput</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">GetWorkerKeyByMinerAddress</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">()))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// A proof must be a valid snark proof with the correct public inputs
</span><span class="c1"></span>	<span class="c1">// 3. Get public inputs
</span><span class="c1"></span>	<span class="nx">info</span> <span class="o">:=</span> <span class="nx">sma</span><span class="p">.</span><span class="nf">Info</span><span class="p">()</span>
	<span class="nx">sectorSize</span> <span class="o">:=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">SectorSize</span><span class="p">()</span>

	<span class="nx">postCfg</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">PoStCfg_I</span><span class="p">{</span>
		<span class="nx">Type_</span><span class="p">:</span>        <span class="nx">sector</span><span class="p">.</span><span class="nx">PoStType_ElectionPoSt</span><span class="p">,</span>
		<span class="nx">SectorSize_</span><span class="p">:</span>  <span class="nx">sectorSize</span><span class="p">,</span>
		<span class="nx">WindowCount_</span><span class="p">:</span> <span class="nx">info</span><span class="p">.</span><span class="nf">WindowCount</span><span class="p">(),</span>
		<span class="nx">Partitions_</span><span class="p">:</span>  <span class="nx">info</span><span class="p">.</span><span class="nf">ElectionPoStPartitions</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="nx">pvInfo</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">PoStVerifyInfo_I</span><span class="p">{</span>
		<span class="nx">OnChain_</span><span class="p">:</span>    <span class="nx">onChainInfo</span><span class="p">,</span>
		<span class="nx">PoStCfg_</span><span class="p">:</span>    <span class="o">&amp;</span><span class="nx">postCfg</span><span class="p">,</span>
		<span class="nx">Randomness_</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">Randomness</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="nx">sdr</span> <span class="o">:=</span> <span class="nx">filproofs</span><span class="p">.</span><span class="nf">WinSDRParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">filproofs</span><span class="p">.</span><span class="nx">SDRCfg_I</span><span class="p">{</span><span class="nx">ElectionPoStCfg_</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">postCfg</span><span class="p">})</span>

	<span class="c1">// 5. Verify the PoSt Proof
</span><span class="c1"></span>	<span class="nx">isPoStVerified</span> <span class="o">:=</span> <span class="nx">sdr</span><span class="p">.</span><span class="nf">VerifyElectionPoSt</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pvInfo</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">isPoStVerified</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">VerifySurprisePoSt</span><span class="p">(</span><span class="nx">header</span> <span class="nx">block</span><span class="p">.</span><span class="nx">BlockHeader</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">,</span> <span class="nx">posterAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>

	<span class="nx">st</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">(),</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">())</span>

	<span class="c1">// 1. Check that the miner in question is currently being challenged
</span><span class="c1"></span>	<span class="k">if</span> <span class="p">!</span><span class="nx">st</span><span class="p">.</span><span class="nf">_isChallenged</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">// TODO: determine proper error here and error-handling machinery
</span><span class="c1"></span>		<span class="c1">// rt.Abort(&#34;cannot SubmitSurprisePoSt when not challenged&#34;)
</span><span class="c1"></span>		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// 2. Check that the challenge has not expired
</span><span class="c1"></span>	<span class="c1">// Check that miner can still submit (i.e. that the challenge window has not passed)
</span><span class="c1"></span>	<span class="c1">// This will prevent miner from submitting a Surprise PoSt past the challenge period
</span><span class="c1"></span>	<span class="k">if</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_challengeHasExpired</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">Epoch</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// A proof must be a valid snark proof with the correct public inputs
</span><span class="c1"></span>
	<span class="c1">// 3. Verify appropriate randomness
</span><span class="c1"></span>	<span class="nx">randomnessEpoch</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">ChallengeStatus</span><span class="p">().</span><span class="nf">LastChallengeEpoch</span><span class="p">()</span>
	<span class="c1">// TODO: fix away from BestChain()... every block should track its own chain up to its own production.
</span><span class="c1"></span>	<span class="nx">randomness</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">GetPoStChallengeRand</span><span class="p">(</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">(),</span> <span class="nx">randomnessEpoch</span><span class="p">)</span>
	<span class="nx">postRandomnessInput</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_preparePoStChallengeSeed</span><span class="p">(</span><span class="nx">randomness</span><span class="p">,</span> <span class="nx">posterAddr</span><span class="p">)</span>

	<span class="nx">postRand</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFResult_I</span><span class="p">{</span>
		<span class="nx">Output_</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">Randomness</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">!</span><span class="nx">postRand</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">postRandomnessInput</span><span class="p">,</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">GetWorkerKeyByMinerAddress</span><span class="p">(</span><span class="nx">posterAddr</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="kc">false</span>
	<span class="p">}</span>

	<span class="c1">// 4. Get public inputs
</span><span class="c1"></span>	<span class="nx">info</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">Info</span><span class="p">()</span>
	<span class="nx">sectorSize</span> <span class="o">:=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">SectorSize</span><span class="p">()</span>

	<span class="nx">postCfg</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">PoStCfg_I</span><span class="p">{</span>
		<span class="nx">Type_</span><span class="p">:</span>        <span class="nx">sector</span><span class="p">.</span><span class="nx">PoStType_SurprisePoSt</span><span class="p">,</span>
		<span class="nx">SectorSize_</span><span class="p">:</span>  <span class="nx">sectorSize</span><span class="p">,</span>
		<span class="nx">WindowCount_</span><span class="p">:</span> <span class="nx">info</span><span class="p">.</span><span class="nf">WindowCount</span><span class="p">(),</span>
		<span class="nx">Partitions_</span><span class="p">:</span>  <span class="nx">info</span><span class="p">.</span><span class="nf">SurprisePoStPartitions</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="nx">pvInfo</span> <span class="o">:=</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">PoStVerifyInfo_I</span><span class="p">{</span>
		<span class="nx">OnChain_</span><span class="p">:</span>    <span class="nx">onChainInfo</span><span class="p">,</span>
		<span class="nx">PoStCfg_</span><span class="p">:</span>    <span class="o">&amp;</span><span class="nx">postCfg</span><span class="p">,</span>
		<span class="nx">Randomness_</span><span class="p">:</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">Randomness</span><span class="p">(),</span>
	<span class="p">}</span>

	<span class="nx">sdr</span> <span class="o">:=</span> <span class="nx">filproofs</span><span class="p">.</span><span class="nf">WinSDRParams</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">filproofs</span><span class="p">.</span><span class="nx">SDRCfg_I</span><span class="p">{</span><span class="nx">SurprisePoStCfg_</span><span class="p">:</span> <span class="o">&amp;</span><span class="nx">postCfg</span><span class="p">})</span>

	<span class="c1">// 5. Verify the PoSt Proof
</span><span class="c1"></span>	<span class="nx">isPoStVerified</span> <span class="o">:=</span> <span class="nx">sdr</span><span class="p">.</span><span class="nf">VerifySurprisePoSt</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">pvInfo</span><span class="p">)</span>
	<span class="k">return</span> <span class="nx">isPoStVerified</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">sms</span> <span class="o">*</span><span class="nx">StorageMiningSubsystem_I</span><span class="p">)</span> <span class="nf">VerifyElection</span><span class="p">(</span><span class="nx">header</span> <span class="nx">block</span><span class="p">.</span><span class="nx">BlockHeader</span><span class="p">,</span> <span class="nx">onChainInfo</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">OnChainPoStVerifyInfo</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">st</span> <span class="o">:=</span> <span class="nx">sms</span><span class="p">.</span><span class="nf">_getStorageMinerActorState</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">(),</span> <span class="nx">header</span><span class="p">.</span><span class="nf">Miner</span><span class="p">())</span>

	<span class="k">for</span> <span class="nx">_</span><span class="p">,</span> <span class="nx">info</span> <span class="o">:=</span> <span class="k">range</span> <span class="nx">onChainInfo</span><span class="p">.</span><span class="nf">Candidates</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">sectorNum</span> <span class="o">:=</span> <span class="nx">info</span><span class="p">.</span><span class="nf">SectorID</span><span class="p">().</span><span class="nf">Number</span><span class="p">()</span>
		<span class="nx">utilInfo</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getUtilizationInfo</span><span class="p">(</span><span class="nx">sectorNum</span><span class="p">)</span>
		<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
			<span class="c1">// panic(err)
</span><span class="c1"></span>			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
		<span class="nx">sectorPower</span> <span class="o">:=</span> <span class="nx">utilInfo</span><span class="p">.</span><span class="nf">CurrUtilization</span><span class="p">()</span>
		<span class="k">if</span> <span class="p">!</span><span class="nx">sms</span><span class="p">.</span><span class="nf">_consensus</span><span class="p">().</span><span class="nf">IsWinningPartialTicket</span><span class="p">(</span><span class="nx">header</span><span class="p">.</span><span class="nf">ParentState</span><span class="p">(),</span> <span class="nx">info</span><span class="p">.</span><span class="nf">PartialTicket</span><span class="p">(),</span> <span class="nx">sectorPower</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="kc">false</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="kc">true</span>
<span class="p">}</span>

<span class="c1">// func (sms *StorageMiningSubsystem_I) submitPoStMessage(postSubmission poster.PoStSubmission) error {
</span><span class="c1">// 	var workerAddress addr.Address
</span><span class="c1">// 	var workerKeyPair filcrypto.SigKeyPair
</span><span class="c1">// 	panic(&#34;TODO&#34;) // TODO: get worker address and key pair
</span><span class="c1"></span>
<span class="c1">// 	// TODO: is this just workerAddress, or is there a separation here
</span><span class="c1">// 	// (worker is AccountActor, workerMiner is StorageMinerActor)?
</span><span class="c1">// 	var workerMinerActorAddress addr.Address
</span><span class="c1">// 	panic(&#34;TODO&#34;)
</span><span class="c1"></span>
<span class="c1">// 	var gasPrice msg.GasPrice
</span><span class="c1">// 	var gasLimit msg.GasAmount
</span><span class="c1">// 	panic(&#34;TODO&#34;) // TODO: determine gas price and limit
</span><span class="c1"></span>
<span class="c1">// 	var callSeqNum actor.CallSeqNum
</span><span class="c1">// 	panic(&#34;TODO&#34;) // TODO: retrieve CallSeqNum from worker
</span><span class="c1"></span>
<span class="c1">// 	messageParams := actor.MethodParams([]actor.MethodParam{
</span><span class="c1">// 		actor.MethodParam(poster.Serialize_PoStSubmission(postSubmission)),
</span><span class="c1">// 	})
</span><span class="c1"></span>
<span class="c1">// 	unsignedMessage := msg.UnsignedMessage_Make(
</span><span class="c1">// 		workerAddress,
</span><span class="c1">// 		workerMinerActorAddress,
</span><span class="c1">// 		Method_StorageMinerActor_SubmitPoSt,
</span><span class="c1">// 		messageParams,
</span><span class="c1">// 		callSeqNum,
</span><span class="c1">// 		actor.TokenAmount(0),
</span><span class="c1">// 		gasPrice,
</span><span class="c1">// 		gasLimit,
</span><span class="c1">// 	)
</span><span class="c1"></span>
<span class="c1">// 	signedMessage, err := msg.Sign(unsignedMessage, workerKeyPair)
</span><span class="c1">// 	if err != nil {
</span><span class="c1">// 		return err
</span><span class="c1">// 	}
</span><span class="c1"></span>
<span class="c1">// 	err = sms.FilecoinNode().SubmitMessage(signedMessage)
</span><span class="c1">// 	if err != nil {
</span><span class="c1">// 		return err
</span><span class="c1">// 	}
</span><span class="c1"></span>
<span class="c1">// 	return nil
</span><span class="c1">// }
</span></code></pre></div>






<h3 id="ticket-validation">Ticket Validation</h3>

<p>Each Ticket should be generated from the prior one in the ticket-chain and verified accordingly as shown in <code>validateTicket</code> below.</p>

<p>


















<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">import</span> <span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor/address&#34;</span>
<span class="kn">import</span> <span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
<span class="kn">import</span> <span class="nx">chain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/chain&#34;</span>
<span class="kn">import</span> <span class="nx">st</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
<span class="kn">import</span> <span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
<span class="kn">import</span> <span class="nx">sector</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
<span class="kn">import</span> <span class="nx">blockchain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain&#34;</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusSubsystem</span> <span class="kd">struct</span> <span class="p">{</span><span class="c1">//(@mutable)
</span><span class="c1"></span>    <span class="nf">ChooseTipsetToMine</span><span class="p">(</span><span class="nx">tipsets</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">])</span> <span class="p">[</span><span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">]</span>

    <span class="nx">ec</span>          <span class="nx">ExpectedConsensus</span>
    <span class="nx">blockchain</span>  <span class="nx">blockchain</span><span class="p">.</span><span class="nx">BlockchainSubsystem</span>

    <span class="c1">// call by BlockchainSubsystem during block reception
</span><span class="c1"></span>    <span class="nf">ValidateBlock</span><span class="p">(</span><span class="nx">block</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Block</span><span class="p">)</span> <span class="kt">error</span>

    <span class="nf">IsWinningPartialTicket</span><span class="p">(</span>
        <span class="nx">st</span>                 <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span>
        <span class="nx">partialTicket</span>      <span class="nx">sector</span><span class="p">.</span><span class="nx">PartialTicket</span>
        <span class="nx">sectorUtilization</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">st</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">StoragePowerActorState</span>

    <span class="nf">validateTicket</span><span class="p">(</span>
        <span class="nx">tix</span>             <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span>
        <span class="nx">pk</span>              <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFPublicKey</span>
        <span class="nx">minerActorAddr</span>  <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span>
    <span class="p">)</span> <span class="kt">bool</span>

    <span class="nf">computeChainWeight</span><span class="p">(</span><span class="nx">tipset</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainWeight</span>

    <span class="nf">StoragePowerConsensusError</span><span class="p">()</span> <span class="nx">StoragePowerConsensusError</span>

    <span class="c1">// Randomness methods
</span><span class="c1"></span>
    <span class="c1">// call by StorageMiningSubsystem during block production
</span><span class="c1"></span>    <span class="nf">GetTicketProductionRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span>

    <span class="c1">// call by StorageMiningSubsystem in sealing sector
</span><span class="c1"></span>    <span class="nf">GetSealRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span>

    <span class="c1">// call by StorageMiningSubsystem after sealing
</span><span class="c1"></span>    <span class="nf">GetPoStChallengeRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span>

    <span class="nf">GetFinality</span><span class="p">()</span>     <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
    <span class="nf">FinalizedEpoch</span><span class="p">()</span>  <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span>
<span class="p">}</span>

<span class="kd">type</span> <span class="nx">StoragePowerConsensusError</span> <span class="kd">struct</span> <span class="p">{}</span>
</code></pre></div>
























<div class="highlight"><pre class="chroma"><code class="language-go" data-lang="go"><span class="kn">package</span> <span class="nx">storage_power_consensus</span>

<span class="kn">import</span> <span class="p">(</span>
	<span class="nx">filcrypto</span> <span class="s">&#34;github.com/filecoin-project/specs/algorithms/crypto&#34;</span>
	<span class="nx">ipld</span> <span class="s">&#34;github.com/filecoin-project/specs/libraries/ipld&#34;</span>
	<span class="nx">block</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/block&#34;</span>
	<span class="nx">chain</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_blockchain/struct/chain&#34;</span>
	<span class="nx">sector</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_mining/sector&#34;</span>
	<span class="nx">node_base</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_nodes/node_base&#34;</span>
	<span class="nx">addr</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/actor/address&#34;</span>
	<span class="nx">stateTree</span> <span class="s">&#34;github.com/filecoin-project/specs/systems/filecoin_vm/state_tree&#34;</span>
	<span class="nx">util</span> <span class="s">&#34;github.com/filecoin-project/specs/util&#34;</span>
<span class="p">)</span>

<span class="kd">const</span> <span class="nx">FINALITY</span> <span class="p">=</span> <span class="mi">500</span>

<span class="kd">const</span> <span class="p">(</span>
	<span class="nx">SPC_LOOKBACK_RANDOMNESS</span> <span class="p">=</span> <span class="mi">300</span>      <span class="c1">// this is EC.K maybe move it there. TODO
</span><span class="c1"></span>	<span class="nx">SPC_LOOKBACK_TICKET</span>     <span class="p">=</span> <span class="mi">1</span>        <span class="c1">// we chain blocks together one after the other
</span><span class="c1"></span>	<span class="nx">SPC_LOOKBACK_POST</span>       <span class="p">=</span> <span class="mi">1</span>        <span class="c1">// cheap to generate, should be set as close to current TS as possible
</span><span class="c1"></span>	<span class="nx">SPC_LOOKBACK_SEAL</span>       <span class="p">=</span> <span class="nx">FINALITY</span> <span class="c1">// should be set to finality
</span><span class="c1"></span><span class="p">)</span>

<span class="c1">// Storage Power Consensus Subsystem
</span><span class="c1"></span>
<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">ValidateBlock</span><span class="p">(</span><span class="nx">block</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Block_I</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">validateTicket</span><span class="p">(</span><span class="nx">ticket</span> <span class="nx">block</span><span class="p">.</span><span class="nx">Ticket</span><span class="p">,</span> <span class="nx">pk</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nx">VRFPublicKey</span><span class="p">,</span> <span class="nx">minerActorAddr</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">Address</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>
	<span class="nx">randomness1</span> <span class="o">:=</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">GetTicketProductionRand</span><span class="p">(</span><span class="nx">spc</span><span class="p">.</span><span class="nf">blockchain</span><span class="p">().</span><span class="nf">BestChain</span><span class="p">(),</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">blockchain</span><span class="p">().</span><span class="nf">LatestEpoch</span><span class="p">())</span>

	<span class="k">return</span> <span class="nx">ticket</span><span class="p">.</span><span class="nf">Verify</span><span class="p">(</span><span class="nx">randomness1</span><span class="p">,</span> <span class="nx">pk</span><span class="p">,</span> <span class="nx">minerActorAddr</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">ComputeChainWeight</span><span class="p">(</span><span class="nx">tipset</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Tipset</span><span class="p">)</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainWeight</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">ec</span><span class="p">().</span><span class="nf">ComputeChainWeight</span><span class="p">(</span><span class="nx">tipset</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">StoragePowerConsensusError</span><span class="p">(</span><span class="nx">errMsg</span> <span class="kt">string</span><span class="p">)</span> <span class="nx">StoragePowerConsensusError</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">IsWinningPartialTicket</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">,</span> <span class="nx">partialTicket</span> <span class="nx">sector</span><span class="p">.</span><span class="nx">PartialTicket</span><span class="p">,</span> <span class="nx">sectorUtilization</span> <span class="nx">block</span><span class="p">.</span><span class="nx">StoragePower</span><span class="p">)</span> <span class="kt">bool</span> <span class="p">{</span>

	<span class="c1">// finalize the partial ticket
</span><span class="c1"></span>	<span class="nx">challengeTicket</span> <span class="o">:=</span> <span class="nx">filcrypto</span><span class="p">.</span><span class="nf">SHA256</span><span class="p">(</span><span class="nx">partialTicket</span><span class="p">)</span>

	<span class="nx">st</span> <span class="o">:=</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span><span class="p">)</span>
	<span class="nx">activePower</span> <span class="o">:=</span> <span class="nx">st</span><span class="p">.</span><span class="nf">_getActivePower</span><span class="p">()</span>

	<span class="c1">// TODO: pull from constants
</span><span class="c1"></span>	<span class="nx">SAMPLE_NUM</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">UVarint</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
	<span class="nx">SAMPLE_DENOM</span> <span class="o">:=</span> <span class="nx">util</span><span class="p">.</span><span class="nf">UVarint</span><span class="p">(</span><span class="mi">25</span><span class="p">)</span>

	<span class="k">return</span> <span class="nx">spc</span><span class="p">.</span><span class="nf">ec</span><span class="p">().</span><span class="nf">IsWinningChallengeTicket</span><span class="p">(</span><span class="nx">challengeTicket</span><span class="p">,</span> <span class="nx">sectorUtilization</span><span class="p">,</span> <span class="nx">activePower</span><span class="p">,</span> <span class="nx">SAMPLE_NUM</span><span class="p">,</span> <span class="nx">SAMPLE_DENOM</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// TODO: fix linking here
</span><span class="c1"></span><span class="kd">var</span> <span class="nx">node</span> <span class="nx">node_base</span><span class="p">.</span><span class="nx">FilecoinNode</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">_getStoragePowerActorState</span><span class="p">(</span><span class="nx">stateTree</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nx">StateTree</span><span class="p">)</span> <span class="nx">StoragePowerActorState</span> <span class="p">{</span>
	<span class="nx">powerAddr</span> <span class="o">:=</span> <span class="nx">addr</span><span class="p">.</span><span class="nx">StoragePowerActorAddr</span>
	<span class="nx">actorState</span> <span class="o">:=</span> <span class="nx">stateTree</span><span class="p">.</span><span class="nf">GetActorState</span><span class="p">(</span><span class="nx">powerAddr</span><span class="p">)</span>
	<span class="nx">substateCID</span> <span class="o">:=</span> <span class="nx">actorState</span><span class="p">.</span><span class="nf">State</span><span class="p">()</span>

	<span class="nx">substate</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">node</span><span class="p">.</span><span class="nf">LocalGraph</span><span class="p">().</span><span class="nf">Get</span><span class="p">(</span><span class="nx">ipld</span><span class="p">.</span><span class="nf">CID</span><span class="p">(</span><span class="nx">substateCID</span><span class="p">))</span>
	<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;TODO&#34;</span><span class="p">)</span>
	<span class="p">}</span>

	<span class="c1">// TODO fix conversion to bytes
</span><span class="c1"></span>	<span class="nb">panic</span><span class="p">(</span><span class="nx">substate</span><span class="p">)</span>
	<span class="kd">var</span> <span class="nx">serializedSubstate</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Serialization</span>
	<span class="nx">st</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nf">Deserialize_StoragePowerActorState</span><span class="p">(</span><span class="nx">serializedSubstate</span><span class="p">)</span>

	<span class="k">if</span> <span class="nx">err</span> <span class="o">==</span> <span class="kc">nil</span> <span class="p">{</span>
		<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;Deserialization error&#34;</span><span class="p">)</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nx">st</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">GetTicketProductionRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">chain</span><span class="p">.</span><span class="nf">RandomnessAtEpoch</span><span class="p">(</span><span class="nx">epoch</span> <span class="o">-</span> <span class="nx">SPC_LOOKBACK_TICKET</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">GetSealRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">chain</span><span class="p">.</span><span class="nf">RandomnessAtEpoch</span><span class="p">(</span><span class="nx">epoch</span> <span class="o">-</span> <span class="nx">SPC_LOOKBACK_SEAL</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">GetPoStChallengeRand</span><span class="p">(</span><span class="nx">chain</span> <span class="nx">chain</span><span class="p">.</span><span class="nx">Chain</span><span class="p">,</span> <span class="nx">epoch</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span><span class="p">)</span> <span class="nx">util</span><span class="p">.</span><span class="nx">Randomness</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">chain</span><span class="p">.</span><span class="nf">RandomnessAtEpoch</span><span class="p">(</span><span class="nx">epoch</span> <span class="o">-</span> <span class="nx">SPC_LOOKBACK_POST</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">GetFinality</span><span class="p">()</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
	<span class="c1">// return FINALITY
</span><span class="c1"></span><span class="p">}</span>

<span class="kd">func</span> <span class="p">(</span><span class="nx">spc</span> <span class="o">*</span><span class="nx">StoragePowerConsensusSubsystem_I</span><span class="p">)</span> <span class="nf">FinalizedEpoch</span><span class="p">()</span> <span class="nx">block</span><span class="p">.</span><span class="nx">ChainEpoch</span> <span class="p">{</span>
	<span class="nb">panic</span><span class="p">(</span><span class="s">&#34;&#34;</span><span class="p">)</span>
	<span class="c1">// currentEpoch := rt.HeadEpoch()
</span><span class="c1"></span>	<span class="c1">// return currentEpoch - spc.GetFinality()
</span><span class="c1"></span><span class="p">}</span>
</code></pre></div>




</p>

<h2 id="repeated-leader-election-attempts">Repeated Leader Election attempts</h2>

<p>In the case that no miner is eligible to produce a block in a given round of EC, the storage power consensus subsystem will be called by the block producer to attempt another leader election by incrementing the nonce appended to the ticket drawn from the past in order to attempt to find a new winning <code>PartialTicket</code> and trying again.
Note that a miner may attempt to grind through tickets by incrementing the nonce repeatedly until they find a winning ticket. However, any block so generated in the future will be rejected by other miners (with synchronized clocks) until that epoch&rsquo;s appropriate time.</p>

<div id="systems__filecoin_blockchain__storage_power_consensus__min_miner_size"></div>

<h2 id="minimum-miner-size">Minimum Miner Size</h2>

<p>In order to secure Storage Power Consensus, the system defines a minimum miner size required to participate in consensus.</p>

<p>Specifically, miners must have either at least <code>MIN_MINER_SIZE_STOR</code> of active power (i.e. storage power currently used in storage deals) or <code>MIN_MINER_SIZE_PERC</code> of the network&rsquo;s active storage power to participate in leader election.</p>

<p>Miners smaller than this cannot mine blocks and earn block rewards in the network. Their power will not be counted as part of total network power. However, <strong>it is important to note that such miners can still have their power faulted and be penalized accordingly</strong>.</p>

<p>Accordingly, to bootstrap the network, the genesis block must include miners taking part in valid storage deals along with appropriate committed storage.</p>

<p>The <code>MIN_MINER_SIZE_PERC</code> condition will not be used in a network with more than <code>MIN_MINER_SIZE_STOR/MIN_MINER_SIZE_PERC</code> of active power. It is nonetheless defined to ensure liveness in small networks (e.g. close to genesis or after large power drops). Simply, a single miner can maintain network liveness for networks with less than <code>MIN_MINER_SIZE_STOR/MIN_MINER_SIZE_PERC</code> of active storage.</p>

<div class="notices placeholder" >The below values are currently placeholders.</div>

<p>We currently set:
- <code>MIN_MINER_SIZE_STOR = 1 &lt;&lt; 40 Bytes</code> (100 TiB)
- <code>MIN_MINER_SIZE_PERC = .33</code></p>
</article>

      

      
    </div>

    
  

  <aside class="book-toc level-6 fixed">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#distinguishing-between-storage-miners-and-block-miners">Distinguishing between storage miners and block miners</a></li>
<li><a href="#on-power">On Power</a></li>
<li><a href="#tickets">Tickets</a>
<ul>
<li><a href="#comparing-tickets-in-a-tipset">Comparing Tickets in a Tipset</a></li>
</ul></li>
<li><a href="#the-ticket-chain-and-drawing-randomness">The Ticket chain and drawing randomness</a>
<ul>
<li><a href="#randomness-ticket-generation">Randomness Ticket generation</a></li>
<li><a href="#ticket-validation">Ticket Validation</a></li>
</ul></li>
<li><a href="#repeated-leader-election-attempts">Repeated Leader Election attempts</a></li>
<li><a href="#minimum-miner-size">Minimum Miner Size</a></li>
</ul></li>
</ul>
</nav>
  </aside>



  </main>

  
  
</body>

</html>
